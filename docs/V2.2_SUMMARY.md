# Version 2.2 - Syst√®me de Calcul de Co√ªt Avanc√©

**Date de release :** 18 d√©cembre 2024
**Fonctionnalit√©s principales :** Calcul de co√ªt avec conversions en cha√Æne et cr√©ation automatique de conversions manquantes

---

## üéØ Objectif de cette version

R√©soudre le probl√®me de calcul de co√ªt lorsque les ingr√©dients utilisent des unit√©s diff√©rentes entre la recette et le catalogue d'achat. Exemple : recette en "pi√®ce", catalogue en "kg".

---

## ‚ú® Nouvelles Fonctionnalit√©s

### 1. Algorithme de Calcul de Co√ªt Avanc√©

**Fichier :** `app/services/cost_calculator.py`

Nouvel algorithme √† **5 priorit√©s** pour r√©soudre les conversions d'unit√©s :

1. **DIRECT** : Unit√© recette = unit√© catalogue ‚Üí calcul imm√©diat
2. **UC (Unit Conversion)** : Conversion standard via `unit_conversion` table
3. **ISC (Ingredient Specific Conversion)** : Conversion sp√©cifique √† l'ingr√©dient
4. **ISC + UC** : Cha√Ænage conversion sp√©cifique + conversion standard
5. **AUTO-CREATE ISC** : Cr√©ation automatique d'une conversion avec factor=1.0

**Support du cha√Ænage :**
```
Recette: 1 pi√®ce carotte
  ‚Üì ISC: pi√®ce ‚Üí g (factor=60)
  ‚Üì UC: g ‚Üí kg (factor=0.001)
  ‚Üì IPC: 1 kg = 5‚Ç¨
  ‚Üí Co√ªt: 0.06 kg √ó 5‚Ç¨ = 0.30‚Ç¨ ‚úÖ
```

### 2. Migration des Conversions en Base de Donn√©es

**Fichier :** `migrations/add_standard_unit_conversions.sql`

Toutes les conversions standard sont maintenant en base de donn√©es (plus de code en dur).

**52 conversions ajout√©es :**
- **14 conversions de poids** : g ‚Üî kg, g ‚Üî mg, tasse ‚Üí g, c.s. ‚Üí g
- **28 conversions de volume** : L ‚Üî ml, cl, dl, c.s., c.c., tasse
- **3 conversions d'unit√©** : pi√®ce, sachet, bo√Æte (identit√©s)

**Cat√©gories :**
- `poids` : Pour ingr√©dients solides (l√©gumes, viandes, farines)
- `volume` : Pour liquides (lait, huile, bouillon)
- `unite` : Pour objets comptables (≈ìufs, sachets)

### 3. Cr√©ation Automatique de Conversions Manquantes

**Comportement :**
- Si une conversion est n√©cessaire mais n'existe pas
- Le syst√®me cr√©e automatiquement une ISC avec `factor=1.0`
- Retourne `status="isc_created"` pour alerter l'utilisateur
- Ajoute une note : `‚ö†Ô∏è Conversion automatique cr√©√©e - √Ä AJUSTER !`

**Exemple :**
```
Recette: 2 pi√®ces pomme de terre
Catalogue: 3.50‚Ç¨/kg
Aucune ISC trouv√©e
  ‚Üí Cr√©ation automatique: pi√®ce ‚Üí kg (factor=1.0)
  ‚Üí Calcul: 2 √ó 1.0 = 2 kg ‚Üí 7.00‚Ç¨ ‚ö†Ô∏è INCORRECT
  ‚Üí L'utilisateur doit ajuster: 1.0 ‚Üí 0.15 (150g/pi√®ce)
  ‚Üí Nouveau calcul: 2 √ó 0.15 = 0.30 kg ‚Üí 1.05‚Ç¨ ‚úÖ
```

### 4. Statuts de Calcul D√©taill√©s

| Status | Signification | Action |
|--------|---------------|--------|
| `"ok"` | Calcul r√©ussi | Aucune |
| `"isc_created"` | Conversion cr√©√©e automatiquement | **Ajuster le facteur !** |
| `"missing_data"` | Ingr√©dient absent du catalogue | Ajouter dans catalogue |
| `"missing_conversion"` | Aucune conversion possible | Cr√©er ISC ou UC |
| `"missing_price"` | Prix NULL dans catalogue | Remplir le prix |

**Distinction claire entre :**
- Donn√©es manquantes (`missing_data`, `missing_conversion`)
- Prix √† z√©ro volontaire (`ok` avec cost=0.0)

### 5. Debug Complet

Chaque calcul retourne un objet `CostResult` avec :
- `cost` : Co√ªt calcul√©
- `status` : Statut du calcul
- `debug` : Toutes les √©tapes du calcul

**Exemple de debug :**
```json
{
  "ingredient_name_fr": "carotte",
  "recipe_qty": 1.0,
  "recipe_unit": "pi√®ce",
  "path": ["isc", "isc->ipc"],
  "conversion_category": "poids",
  "isc_from": "pi√®ce",
  "isc_to": "kg",
  "isc_factor": 0.06,
  "qty_after_isc": 0.06,
  "ipc_unit": "kg",
  "pack_price": 5.0
}
```

---

## üîß Modifications Techniques

### Fichiers Modifi√©s

| Fichier | Modifications |
|---------|---------------|
| `app/services/cost_calculator.py` | **NOUVEAU** - Algorithme de calcul de co√ªt |
| `app/models/db_recipes.py` | `calculate_recipe_cost()` utilise le nouveau syst√®me |
| `app/routes/event_routes.py` | Budget et sync prix utilisent le nouveau syst√®me |
| `migrations/add_standard_unit_conversions.sql` | **NOUVEAU** - 52 conversions standard |
| `docs/COST_CALCULATION_SYSTEM.md` | **NOUVEAU** - Documentation compl√®te |

### Sch√©ma de Base de Donn√©es

**Tables utilis√©es :**

```sql
-- Catalogue des prix
ingredient_price_catalog (
  id, ingredient_name_fr, unit_fr, price_eur, price_jpy, qty,
  conversion_category -- "poids", "volume", "unite"
)

-- Conversions standard
unit_conversion (
  id, from_unit, to_unit, factor, category,
  from_unit_fr, to_unit_fr, from_unit_jp, to_unit_jp
)

-- Conversions sp√©cifiques
ingredient_specific_conversions (
  id, ingredient_name_fr, from_unit, to_unit, factor, notes
)
```

**Formule de calcul :**
```
unit_price = pack_price / pack_qty
cost = qty_in_catalog_unit √ó unit_price
```

---

## üß™ Tests

### 1. Test Carottes (`test_carrot_cost.py`)

**Sc√©nario :** Conversion en cha√Æne ISC + UC
```
Recette: 1 pi√®ce
ISC: pi√®ce ‚Üí kg (factor=0.06)
Catalogue: 1 kg = 5‚Ç¨
R√©sultat: 0.30‚Ç¨ ‚úÖ
```

### 2. Test Cr√©ation Auto (`test_auto_isc_creation.py`)

**Sc√©nario :** Premi√®re utilisation sans conversion
```
1er calcul:
  - ISC cr√©√©e: pi√®ce ‚Üí kg (factor=1.0)
  - Status: "isc_created"
  - Co√ªt: 7.00‚Ç¨ (incorrect)

2e calcul:
  - ISC utilis√©e normalement
  - Status: "ok"
  - Co√ªt: 7.00‚Ç¨ (jusqu'√† ajustement du facteur)
```

---

## üìö Documentation

### Guide d'Utilisation (`docs/COST_CALCULATION_SYSTEM.md`)

Documentation compl√®te incluant :
- Architecture et algorithme
- Cat√©gories de conversion
- Formule de calcul d√©taill√©e
- Guide d'utilisation avec exemples SQL/Python
- Bonnes pratiques
- D√©bogage

### Exemples Concrets

**1. Ajouter un nouvel ingr√©dient :**
```sql
INSERT INTO ingredient_price_catalog
(ingredient_name_fr, unit_fr, price_eur, qty, conversion_category)
VALUES ('tomate', 'kg', 4.50, 1.0, 'poids');
```

**2. Ajouter une conversion sp√©cifique :**
```sql
INSERT INTO ingredient_specific_conversions
(ingredient_name_fr, from_unit, to_unit, factor, notes)
VALUES ('tomate', 'pi√®ce', 'kg', 0.12, '1 tomate moyenne ‚âà 120g');
```

**3. Tester le calcul :**
```python
from app.services.cost_calculator import compute_estimated_cost_for_ingredient

result = compute_estimated_cost_for_ingredient(
    conn=conn,
    ingredient_name_fr="tomate",
    recipe_qty=3.0,
    recipe_unit="pi√®ce",
    currency="EUR"
)

print(f"Co√ªt: {result.cost}‚Ç¨")  # 1.62‚Ç¨ (3√ó0.12√ó4.50)
print(f"Status: {result.status}")  # "ok"
```

---

## üéØ Cas d'Usage R√©solus

### Probl√®me Initial

**Situation :**
- Recette utilise : 1 pi√®ce de carotte
- Conversion sp√©cifique : 1 pi√®ce = 60g
- Catalogue : 1 kg = 5‚Ç¨
- Conversion standard : 1g = 0.001 kg

**Ancien syst√®me :**
- Ne trouvait pas la conversion `pi√®ce ‚Üí kg`
- Retournait prix = 0 ou erreur

**Nouveau syst√®me :**
1. Cherche ISC : `pi√®ce ‚Üí ?` ‚Üí Trouve `pi√®ce ‚Üí 0.06 kg` ‚úÖ
2. Convertit : `1 pi√®ce √ó 0.06 = 0.06 kg`
3. Applique prix : `0.06 √ó 5‚Ç¨ = 0.30‚Ç¨` ‚úÖ

### Nouveau Cas : Conversion Manquante

**Situation :**
- Recette : 2 pi√®ces de pomme de terre
- Aucune ISC d√©finie
- Catalogue : 1 kg = 3.50‚Ç¨

**Comportement :**
1. Cr√©e ISC automatiquement : `pi√®ce ‚Üí kg (factor=1.0)`
2. Calcule avec factor par d√©faut : `2 √ó 1.0 √ó 3.50‚Ç¨ = 7.00‚Ç¨` ‚ö†Ô∏è
3. Retourne `status="isc_created"` pour alerter l'utilisateur
4. L'utilisateur ajuste le facteur : `1.0 ‚Üí 0.15`
5. Recalcul correct : `2 √ó 0.15 √ó 3.50‚Ç¨ = 1.05‚Ç¨` ‚úÖ

---

## ‚ö†Ô∏è Points d'Attention

### 1. Conversions Automatiques

Les conversions cr√©√©es automatiquement ont un **facteur par d√©faut de 1.0** qui est **TOUJOURS INCORRECT**.

**Action requise :**
- Surveiller le status `"isc_created"`
- Aller dans la gestion des conversions
- Ajuster le facteur selon la r√©alit√©
- Exemples r√©alistes :
  - Carotte : 1 pi√®ce ‚âà 0.06 kg (60g)
  - Pomme de terre : 1 pi√®ce ‚âà 0.15 kg (150g)
  - Tomate : 1 pi√®ce ‚âà 0.12 kg (120g)
  - ≈íuf : 1 pi√®ce ‚âà 0.06 kg (60g)

### 2. Cat√©gories de Conversion

**Important :** Le champ `conversion_category` dans `ingredient_price_catalog` doit √™tre correct :
- `poids` : Pour tout ce qui se p√®se
- `volume` : Pour les liquides
- `unite` : Pour les objets comptables

### 3. Ne Pas Dupliquer les Conversions Standard

‚ùå **Ne pas cr√©er d'ISC pour :**
- `g ‚Üí kg` (d√©j√† dans `unit_conversion`)
- `ml ‚Üí L` (d√©j√† dans `unit_conversion`)
- etc.

‚úÖ **Cr√©er des ISC seulement pour :**
- Conversions sp√©cifiques √† un ingr√©dient
- Exemple : `pi√®ce ‚Üí kg` pour "carotte"

---

## üöÄ B√©n√©fices

1. **Calculs corrects** : Plus d'erreurs de conversion
2. **Flexibilit√©** : Support de multiples unit√©s par ingr√©dient
3. **Autonomie** : Cr√©ation automatique des conversions manquantes
4. **Transparence** : Debug complet pour comprendre les calculs
5. **Maintenabilit√©** : Toutes les conversions en base de donn√©es
6. **√âvolutivit√©** : Facile d'ajouter de nouvelles conversions

---

## üìä Statistiques

- **5 fichiers modifi√©s** : cost_calculator.py (nouveau), db_recipes.py, event_routes.py, 2 docs
- **2 tests cr√©√©s** : test_carrot_cost.py, test_auto_isc_creation.py
- **52 conversions** ajout√©es en base
- **5 statuts** distincts pour les r√©sultats
- **5 priorit√©s** dans l'algorithme de r√©solution
- **100% en base** : Aucune donn√©e de conversion en dur dans le code
- **2 fonctionnalit√©s** utilisant le m√™me algorithme : Recettes + √âv√©nements

---

## üîú Am√©liorations Futures Possibles

1. **Interface UI pour ISC** : G√©rer les conversions sp√©cifiques visuellement
2. **Suggestions intelligentes** : Proposer des facteurs r√©alistes selon le type d'ingr√©dient
3. **Historique des ajustements** : Tracer les modifications de facteurs
4. **Validation des facteurs** : Alerter si factor semble aberrant (ex: > 10)
5. **Import/Export** : Partager des biblioth√®ques de conversions

---

*Derni√®re mise √† jour : 18 d√©cembre 2024*
