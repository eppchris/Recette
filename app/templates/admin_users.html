{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">
      {% if lang == 'fr' %}
        Gestion des utilisateurs
      {% else %}
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
      {% endif %}
    </h1>
    <p class="text-gray-600 dark:text-gray-400">
      {% if lang == 'fr' %}
        Liste de tous les utilisateurs de l'application
      {% else %}
        ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
      {% endif %}
    </p>
  </div>

  <!-- Message de succÃ¨s -->
  {% if success %}
  <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-600 dark:text-green-400">
    {{ success }}
  </div>
  {% endif %}

  <!-- Message d'erreur -->
  {% if error %}
  <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400">
    {{ error }}
  </div>
  {% endif %}

  <!-- Statistiques -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ users|length }}</div>
      <div class="text-sm text-gray-600 dark:text-gray-400">
        {% if lang == 'fr' %}Total utilisateurs{% else %}ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°{% endif %}
      </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="text-3xl font-bold text-green-600 dark:text-green-400">
        {{ users|selectattr('is_active', 'equalto', 1)|list|length }}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">
        {% if lang == 'fr' %}Actifs{% else %}æœ‰åŠ¹{% endif %}
      </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">
        {{ users|selectattr('is_admin', 'equalto', 1)|list|length }}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">
        {% if lang == 'fr' %}Admins{% else %}ç®¡ç†è€…{% endif %}
      </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="text-3xl font-bold text-gray-600 dark:text-gray-400">
        {{ users|selectattr('is_active', 'equalto', 0)|list|length }}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400">
        {% if lang == 'fr' %}Inactifs{% else %}ç„¡åŠ¹{% endif %}
      </div>
    </div>
  </div>

  <!-- Bouton nouveau -->
  <div class="mb-6">
    <a
      href="/admin/users/new?lang={{ lang }}"
      class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition"
    >
      <span>â•</span>
      <span>{% if lang == 'fr' %}Nouvel utilisateur{% else %}æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼{% endif %}</span>
    </a>
  </div>

  <!-- Table des utilisateurs -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-900">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}Utilisateur{% else %}ãƒ¦ãƒ¼ã‚¶ãƒ¼{% endif %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}Email{% else %}ãƒ¡ãƒ¼ãƒ«{% endif %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}RÃ´le{% else %}å½¹å‰²{% endif %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}Statut{% else %}ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹{% endif %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}CrÃ©Ã© le{% else %}ä½œæˆæ—¥{% endif %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}DerniÃ¨re connexion{% else %}æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³{% endif %}
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {% if lang == 'fr' %}Actions{% else %}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³{% endif %}
          </th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
        {% for user in users %}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="text-2xl mr-3">ğŸ‘¤</div>
              <div>
                <div class="text-sm font-medium">{{ user.username }}</div>
                {% if user.display_name %}
                <div class="text-sm text-gray-500 dark:text-gray-400">{{ user.display_name }}</div>
                {% endif %}
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm">{{ user.email }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if user.is_admin %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
              â­ {% if lang == 'fr' %}Admin{% else %}ç®¡ç†è€…{% endif %}
            </span>
            {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
              {% if lang == 'fr' %}Utilisateur{% else %}ãƒ¦ãƒ¼ã‚¶ãƒ¼{% endif %}
            </span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if user.is_active %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
              âœ“ {% if lang == 'fr' %}Actif{% else %}æœ‰åŠ¹{% endif %}
            </span>
            {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
              âœ— {% if lang == 'fr' %}Inactif{% else %}ç„¡åŠ¹{% endif %}
            </span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
            {{ user.created_at.split(' ')[0] if user.created_at else '-' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
            {{ user.last_login.split(' ')[0] if user.last_login else '-' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            {% if user.id != request.session.get('user_id') %}
            <div class="flex gap-2 justify-end" x-data="{ showPasswordModal: false }">
              <!-- Bouton Activer/DÃ©sactiver -->
              <form method="POST" action="/admin/users/{{ user.id }}/toggle-active?lang={{ lang }}" class="inline">
                <button
                  type="submit"
                  class="{% if user.is_active %}text-orange-600 hover:text-orange-900 dark:text-orange-400{% else %}text-green-600 hover:text-green-900 dark:text-green-400{% endif %}"
                  onclick="return confirm('{% if lang == 'fr' %}ÃŠtes-vous sÃ»r ?{% else %}æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ{% endif %}')"
                  title="{% if user.is_active %}{% if lang == 'fr' %}DÃ©sactiver{% else %}ç„¡åŠ¹åŒ–{% endif %}{% else %}{% if lang == 'fr' %}Activer{% else %}æœ‰åŠ¹åŒ–{% endif %}{% endif %}"
                >
                  {% if user.is_active %}
                    {% if lang == 'fr' %}DÃ©sactiver{% else %}ç„¡åŠ¹åŒ–{% endif %}
                  {% else %}
                    {% if lang == 'fr' %}Activer{% else %}æœ‰åŠ¹åŒ–{% endif %}
                  {% endif %}
                </button>
              </form>

              <!-- Bouton Changer mot de passe -->
              <button
                @click="showPasswordModal = true"
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400"
                title="{% if lang == 'fr' %}Changer le mot de passe{% else %}ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´{% endif %}"
              >
                {% if lang == 'fr' %}Mot de passe{% else %}ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰{% endif %}
              </button>

              <!-- Bouton Supprimer -->
              <form method="POST" action="/admin/users/{{ user.id }}/delete?lang={{ lang }}" class="inline">
                <button
                  type="submit"
                  class="text-red-600 hover:text-red-900 dark:text-red-400"
                  onclick="return confirm('{% if lang == 'fr' %}Voulez-vous vraiment supprimer {{ user.username }} ? Cette action est irrÃ©versible.{% else %}{{ user.username }} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚{% endif %}')"
                  title="{% if lang == 'fr' %}Supprimer{% else %}å‰Šé™¤{% endif %}"
                >
                  {% if lang == 'fr' %}Supprimer{% else %}å‰Šé™¤{% endif %}
                </button>
              </form>

              <!-- Modal Changement de mot de passe -->
              <div
                x-show="showPasswordModal"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                @click.self="showPasswordModal = false"
              >
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                  <h3 class="text-lg font-bold mb-4">
                    {% if lang == 'fr' %}Changer le mot de passe de {{ user.username }}{% else %}{{ user.username }} ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´{% endif %}
                  </h3>
                  <form method="POST" action="/admin/users/{{ user.id }}/reset-password?lang={{ lang }}">
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium mb-2">
                          {% if lang == 'fr' %}Nouveau mot de passe{% else %}æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰{% endif %}
                        </label>
                        <input
                          type="password"
                          name="new_password"
                          required
                          minlength="6"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"
                        >
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">
                          {% if lang == 'fr' %}Confirmer le mot de passe{% else %}ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª{% endif %}
                        </label>
                        <input
                          type="password"
                          name="new_password_confirm"
                          required
                          minlength="6"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"
                        >
                      </div>
                      <div class="flex gap-2 justify-end">
                        <button
                          type="button"
                          @click="showPasswordModal = false"
                          class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
                        >
                          {% if lang == 'fr' %}Annuler{% else %}ã‚­ãƒ£ãƒ³ã‚»ãƒ«{% endif %}
                        </button>
                        <button
                          type="submit"
                          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                        >
                          {% if lang == 'fr' %}Enregistrer{% else %}ä¿å­˜{% endif %}
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% else %}
            <span class="text-gray-400 dark:text-gray-600">
              {% if lang == 'fr' %}Vous{% else %}ã‚ãªãŸ{% endif %}
            </span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
