{% extends 'base.html' %}
{% block content %}
<article class="bg-white border p-6 rounded" x-data="recipeDetail()">
  <!-- En-tÃªte de la recette -->
  <header class="mb-6 pb-4 border-b">
    <div class="flex justify-between items-start mb-3">
      <h1 class="text-3xl font-bold">{{ rec['name'] }}</h1>

      <div class="flex gap-2">
        <!-- Bouton de modification -->
        <button
          @click="openEditModal()"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition-colors"
        >
          {{ 'ç·¨é›†' if lang == 'jp' else 'Modifier' }}
        </button>

        <!-- Bouton de traduction (affichÃ© seulement si pas de traduction) -->
        {% if not rec['name'] or rec['name'] == rec['slug'] %}
        <button
          @click="translateRecipe()"
          :disabled="translating"
          :class="apiStatus === 'operational' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'"
          class="px-4 py-2 text-white rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          <span x-show="!translating">{{ 'ç¿»è¨³' if lang == 'jp' else 'Traduction' }}</span>
          <span x-show="translating">â³ Traduction...</span>
        </button>
        {% endif %}
      </div>
    </div>
    <div class="flex flex-wrap gap-4 text-sm text-gray-700">
      <div>
        <span class="font-semibold">{{ S('type') }}:</span>
        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ rec['type_label'] or rec['type'] or '-' }}</span>
      </div>
      <div>
        <span class="font-semibold">{{ S('servings') }}:</span>
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded">{{ rec['servings'] or '-' }}</span>
      </div>
      {% if rec['source'] %}
      <div>
        <span class="font-semibold">{{ S('source') }}:</span>
        <a class="text-blue-600 hover:underline" href="{{ rec['source'] }}" target="_blank">lien</a>
      </div>
      {% endif %}
    </div>
  </header>

  <!-- Message de statut -->
  <div x-show="message"
       x-transition
       :class="messageType === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'"
       class="border px-4 py-3 rounded mb-4"
       role="alert">
    <p x-text="message"></p>
  </div>

  <!-- Section Conversion de recette -->
  <section class="mb-8">
    <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4">
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <div class="flex-shrink-0">
          <h3 class="text-lg font-bold text-green-900">
            ğŸ§® {{ 'Conversion de quantitÃ©s' if lang == 'fr' else 'åˆ†é‡å¤‰æ›' }}
          </h3>
        </div>

        <div class="flex items-center gap-3">
          <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">
            {{ 'Nombre de personnes:' if lang == 'fr' else 'äººæ•°:' }}
          </label>
          <div class="flex items-center gap-2">
            <button
              @click="targetServings = Math.max(1, targetServings - 1)"
              class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full font-bold transition"
            >
              âˆ’
            </button>
            <input
              type="number"
              x-model.number="targetServings"
              min="1"
              max="50"
              class="w-16 text-center px-2 py-1 border rounded"
            >
            <button
              @click="targetServings = Math.min(50, targetServings + 1)"
              class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full font-bold transition"
            >
              +
            </button>
          </div>
        </div>

        <button
          @click="convertRecipe()"
          :disabled="converting || targetServings === originalServings"
          class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap"
        >
          <span x-show="!converting">{{ 'âœ¨ Convertir' if lang == 'fr' else 'âœ¨ å¤‰æ›' }}</span>
          <span x-show="converting">{{ 'â³ Conversion...' if lang == 'fr' else 'â³ å¤‰æ›ä¸­...' }}</span>
        </button>

        <p class="text-xs text-gray-600 ml-auto whitespace-nowrap">
          {{ 'Recette originale:' if lang == 'fr' else 'å…ƒã®ãƒ¬ã‚·ãƒ”:' }}
          <strong x-text="originalServings"></strong>
          {{ 'pers.' if lang == 'fr' else 'äººåˆ†' }}
        </p>
      </div>
    </div>
  </section>

  <!-- Section IngrÃ©dients -->
  <section class="mb-8">
    <h2 class="text-xl font-bold mb-3">
      {{ S('ingredients') }}
      <span x-show="showingConversion" class="text-sm text-green-600 ml-2">
        ({{ 'pour' if lang == 'fr' else '' }} <span x-text="targetServings"></span> {{ 'personne(s)' if lang == 'fr' else 'äººåˆ†' }})
      </span>
      <button
        x-show="showingConversion"
        @click="resetConversion()"
        class="ml-3 text-sm text-blue-600 hover:underline"
      >
        {{ 'Afficher quantitÃ©s originales' if lang == 'fr' else 'å…ƒã®é‡ã‚’è¡¨ç¤º' }}
      </button>
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300 text-sm">
        <thead>
          <tr class="bg-gray-100">
            <th class="border border-gray-300 px-3 py-2 text-left font-semibold">{{ S('ingredients') }}</th>
            <th class="border border-gray-300 px-3 py-2 text-center font-semibold w-24">QuantitÃ©</th>
            <th class="border border-gray-300 px-3 py-2 text-center font-semibold w-24">UnitÃ©</th>
            <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Commentaire</th>
          </tr>
        </thead>
        <tbody>
          {% for ig in ings %}
          <tr class="hover:bg-gray-50" x-show="!showingConversion">
            <td class="border border-gray-300 px-3 py-2">{{ ig['name'] or '-' }}</td>
            <td class="border border-gray-300 px-3 py-2 text-center">
              {{ ig['quantity'] if ig['quantity'] is not none else '-' }}
            </td>
            <td class="border border-gray-300 px-3 py-2 text-center">
              {{ ig['unit'] or '-' }}
            </td>
            <td class="border border-gray-300 px-3 py-2 text-gray-600">
              {{ ig['notes'] or '-' }}
            </td>
          </tr>
          {% endfor %}

          <template x-for="ing in convertedIngredients" :key="ing.id">
            <tr class="hover:bg-gray-50" x-show="showingConversion" :class="ing.is_negligible ? 'bg-yellow-50' : ''">
              <td class="border border-gray-300 px-3 py-2">
                <span x-text="ing.name"></span>
                <span x-show="ing.is_negligible" class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded">
                  {{ 'nÃ©gligeable' if lang == 'fr' else 'ç„¡è¦–å¯èƒ½' }}
                </span>
              </td>
              <td class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-700">
                <span x-text="ing.converted_quantity !== null && ing.converted_quantity !== undefined ? ing.converted_quantity : '-'"></span>
              </td>
              <td class="border border-gray-300 px-3 py-2 text-center">
                <span x-text="ing.purchase_unit || ing.unit || '-'"></span>
              </td>
              <td class="border border-gray-300 px-3 py-2 text-gray-600">
                <span x-text="ing.notes || '-'"></span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Section Ã‰tapes -->
  <section class="mb-8">
    <h2 class="text-xl font-bold mb-3">{{ S('steps') }}</h2>
    <ol class="space-y-3">
      {% for s in steps %}
      <li class="flex gap-3">
        <span class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-sm">
          {{ loop.index }}
        </span>
        <p class="flex-1 pt-1">{{ s['text'] }}</p>
      </li>
      {% endfor %}
    </ol>
  </section>

  <!-- Section Image et informations -->
  <section class="mb-8">
    <div class="flex flex-col md:flex-row gap-6 items-start">
      <!-- Affichage de l'image -->
      <div class="w-full md:w-1/2">
        <div class="relative group">
          <img
            :src="recipeImage || '/static/images/recipe-placeholder.jpg'"
            alt="{{ rec['name'] }}"
            class="w-full rounded-lg shadow-md object-cover"
            style="max-height: 400px"
          >
          <!-- Boutons d'action sur l'image (affichÃ©s au survol) -->
          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all rounded-lg flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100">
            <button
              @click="$refs.imageInput.click()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-lg"
            >
              ğŸ“· {{ 'Modifier' if lang == 'fr' else 'å¤‰æ›´' }}
            </button>
            <button
              x-show="recipeImage"
              @click="deleteImage()"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors shadow-lg"
            >
              ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
            </button>
          </div>
        </div>

        <!-- Input file cachÃ© -->
        <input
          type="file"
          x-ref="imageInput"
          @change="uploadImage($event)"
          accept="image/jpeg,image/png,image/webp"
          class="hidden"
        >

        <!-- Indicateur de chargement -->
        <div x-show="uploadingImage" class="mt-3 text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-sm text-gray-600">{{ 'Upload en cours...' if lang == 'fr' else 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' }}</p>
        </div>
      </div>

      <!-- Informations photo -->
      <div class="w-full md:w-1/2">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="font-semibold text-blue-900 mb-2">ğŸ“· {{ 'Photo de la recette' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”å†™çœŸ' }}</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>âœ“ {{ 'Formats acceptÃ©s: JPG, PNG, WebP, GIF' if lang == 'fr' else 'å¯¾å¿œå½¢å¼: JPGã€PNGã€WebPã€GIF' }}</li>
            <li>âœ“ {{ 'Taille max: 5 MB' if lang == 'fr' else 'æœ€å¤§ã‚µã‚¤ã‚º: 5 MB' }}</li>
            <li>ğŸ’¡ {{ 'Conseil: optimisez vos images avant upload' if lang == 'fr' else 'ãƒ’ãƒ³ãƒˆ: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«ç”»åƒã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„' }}</li>
          </ul>
          <p class="mt-3 text-sm text-gray-700">
            {{ 'Survolez l\'image pour afficher les options de modification.' if lang == 'fr' else 'ç”»åƒã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã¨ç·¨é›†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚' }}
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Bouton retour -->
  <div class="mt-8 pt-4 border-t">
    <a href="/recipes?lang={{ lang }}" class="text-blue-600 hover:underline">
      â† {{ S('back') if S('back') != 'back' else 'Retour' }}
    </a>
  </div>

  <!-- Modal de modification -->
  <div x-show="editMode"
       x-cloak
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
       @click.self="closeEditModal()">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
      <!-- En-tÃªte du modal -->
      <div class="flex justify-between items-center mb-6 pb-4 border-b">
        <h2 class="text-2xl font-bold">{{ 'ãƒ¬ã‚·ãƒ”ã®ç·¨é›†' if lang == 'jp' else 'Modification de la recette' }}</h2>
        <button @click="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
          Ã—
        </button>
      </div>

      <!-- Section Informations gÃ©nÃ©rales -->
      <div class="mb-8 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-xl font-bold mb-4">{{ 'åŸºæœ¬æƒ…å ±' if lang == 'jp' else 'Informations gÃ©nÃ©rales' }}</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">
              {{ 'ã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Type de recette' }}
            </label>
            <input
              type="text"
              x-model="editData.recipe_type"
              placeholder="{{ 'ã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Ex: Plat principal, Dessert...' }}"
              class="w-full px-3 py-2 border rounded"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">
              {{ 'äººæ•°' if lang == 'jp' else 'Nombre de personnes' }}
            </label>
            <input
              type="number"
              min="1"
              x-model="editData.servings_default"
              placeholder="{{ 'äººæ•°' if lang == 'jp' else 'Ex: 4' }}"
              class="w-full px-3 py-2 border rounded"
            />
          </div>
        </div>
      </div>

      <!-- Section IngrÃ©dients -->
      <div class="mb-8">
        <h3 class="text-xl font-bold mb-3">{{ S('ingredients') }}</h3>
        <div class="space-y-2">
          <template x-for="(ing, index) in editData.ingredients" :key="index">
            <div class="grid grid-cols-12 gap-2 items-center p-2 border rounded">
              <div class="col-span-5">
                <input
                  type="text"
                  x-model="ing.name"
                  placeholder="Nom de l'ingrÃ©dient"
                  class="w-full px-2 py-1 border rounded"
                />
              </div>
              <div class="col-span-2">
                <input
                  type="number"
                  step="0.01"
                  x-model="ing.quantity"
                  placeholder="QtÃ©"
                  class="w-full px-2 py-1 border rounded"
                />
              </div>
              <div class="col-span-2">
                <input
                  type="text"
                  x-model="ing.unit"
                  placeholder="UnitÃ©"
                  class="w-full px-2 py-1 border rounded"
                />
              </div>
              <div class="col-span-3">
                <input
                  type="text"
                  x-model="ing.notes"
                  placeholder="Notes"
                  class="w-full px-2 py-1 border rounded"
                />
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Section Ã‰tapes -->
      <div class="mb-8">
        <h3 class="text-xl font-bold mb-3">{{ S('steps') }}</h3>
        <div class="space-y-3">
          <template x-for="(step, index) in editData.steps" :key="index">
            <div class="flex gap-3">
              <span class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-sm" x-text="index + 1"></span>
              <textarea
                x-model="step.text"
                rows="3"
                class="flex-1 px-3 py-2 border rounded resize-y"
                :placeholder="'Ã‰tape ' + (index + 1)"
              ></textarea>
            </div>
          </template>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button
          @click="closeEditModal()"
          class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-semibold transition-colors"
        >
          {{ 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' if lang == 'jp' else 'Annuler' }}
        </button>
        <button
          @click="saveRecipe()"
          :disabled="saving"
          class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold disabled:opacity-50 transition-colors"
        >
          <span x-show="!saving">{{ 'ä¿å­˜' if lang == 'jp' else 'Enregistrer' }}</span>
          <span x-show="saving">{{ 'ä¿å­˜ä¸­...' if lang == 'jp' else 'Enregistrement...' }}</span>
        </button>
      </div>
    </div>
  </div>
</article>

<style>
  [x-cloak] { display: none !important; }
</style>

<script>
  function recipeDetail() {
    return {
      apiStatus: 'checking',
      translating: false,
      message: '',
      messageType: 'info',
      editMode: false,
      saving: false,
      uploadingImage: false,
      recipeImage: '{{ rec["image_url"] or "" }}',
      editData: {
        ingredients: [],
        steps: []
      },
      originalData: null,
      // Conversion
      originalServings: {{ rec['servings'] or 1 }},
      targetServings: {{ rec['servings'] or 1 }},
      converting: false,
      showingConversion: false,
      convertedIngredients: [],

      async init() {
        // VÃ©rifier le statut de l'API au chargement
        await this.checkApiStatus();
        // Initialiser les donnÃ©es d'Ã©dition
        this.initEditData();
      },

      initEditData() {
        // RÃ©cupÃ©rer les donnÃ©es actuelles depuis le DOM
        this.originalData = {
          ingredients: {{ ings | tojson | safe }},
          steps: {{ steps | tojson | safe }},
          recipe_type: '{{ rec["type"] or "" }}',
          servings_default: {{ rec['servings'] or 'null' }}
        };
      },

      async checkApiStatus() {
        try {
          const response = await fetch('/api/translation/status');
          const data = await response.json();
          this.apiStatus = data.status;
        } catch (error) {
          console.error('Erreur lors de la vÃ©rification du statut API:', error);
          this.apiStatus = 'error';
        }
      },

      async translateRecipe() {
        this.translating = true;
        this.message = '';

        try {
          const response = await fetch('/api/translate/{{ rec["slug"] }}?target_lang={{ lang }}', {
            method: 'POST'
          });

          const data = await response.json();

          if (data.success) {
            this.message = data.message;
            this.messageType = 'success';

            // Recharger la page aprÃ¨s 2 secondes pour afficher la traduction
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            this.message = data.message;
            this.messageType = 'error';
            this.translating = false;
          }
        } catch (error) {
          console.error('Erreur lors de la traduction:', error);
          this.message = 'Erreur lors de la communication avec le serveur';
          this.messageType = 'error';
          this.translating = false;
        }
      },

      openEditModal() {
        // CrÃ©er une copie profonde des donnÃ©es originales
        this.editData = {
          ingredients: JSON.parse(JSON.stringify(this.originalData.ingredients)),
          steps: JSON.parse(JSON.stringify(this.originalData.steps)),
          recipe_type: this.originalData.recipe_type,
          servings_default: this.originalData.servings_default
        };
        this.editMode = true;
        this.message = '';
      },

      closeEditModal() {
        // Fermer le modal sans sauvegarder
        this.editMode = false;
        this.editData = {
          ingredients: [],
          steps: []
        };
      },

      async saveRecipe() {
        this.saving = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}?lang={{ lang }}', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ingredients: this.editData.ingredients,
              steps: this.editData.steps,
              recipe_type: this.editData.recipe_type,
              servings_default: this.editData.servings_default
            })
          });

          const data = await response.json();

          if (data.success) {
            this.message = data.message;
            this.messageType = 'success';
            this.editMode = false;

            // Recharger la page aprÃ¨s 1 seconde pour afficher les modifications
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            this.message = data.message;
            this.messageType = 'error';
            this.saving = false;
          }
        } catch (error) {
          console.error('Erreur lors de la sauvegarde:', error);
          this.message = 'Erreur lors de la communication avec le serveur';
          this.messageType = 'error';
          this.saving = false;
        }
      },

      async uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        // VÃ©rifier la taille (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          this.message = '{{ "Fichier trop volumineux (max 5 MB)" if lang == "fr" else "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§5 MBï¼‰" }}';
          this.messageType = 'error';
          return;
        }

        // VÃ©rifier le type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          this.message = '{{ "Format non supportÃ©. Utilisez JPG, PNG ou WebP" if lang == "fr" else "éå¯¾å¿œã®å½¢å¼ã§ã™ã€‚JPGã€PNGã€WebPã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" }}';
          this.messageType = 'error';
          return;
        }

        this.uploadingImage = true;
        this.message = '';

        try {
          const formData = new FormData();
          formData.append('file', file);

          const response = await fetch('/api/recipe/{{ rec["slug"] }}/image', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            this.recipeImage = data.image_url;
            this.message = data.message;
            this.messageType = 'success';

            // RÃ©initialiser l'input file
            event.target.value = '';
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de l\'upload:', error);
          this.message = '{{ "Erreur lors de l\\'upload" if lang == "fr" else "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.uploadingImage = false;
        }
      },

      async deleteImage() {
        if (!confirm('{{ "ÃŠtes-vous sÃ»r de vouloir supprimer cette image ?" if lang == "fr" else "ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" }}')) {
          return;
        }

        this.uploadingImage = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}/image', {
            method: 'DELETE'
          });

          const data = await response.json();

          if (data.success) {
            this.recipeImage = '';
            this.message = data.message;
            this.messageType = 'success';
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de la suppression:', error);
          this.message = '{{ "Erreur lors de la suppression" if lang == "fr" else "å‰Šé™¤ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.uploadingImage = false;
        }
      },

      async convertRecipe() {
        this.converting = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}/convert?lang={{ lang }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              target_servings: this.targetServings
            })
          });

          const data = await response.json();

          if (data.success) {
            this.convertedIngredients = data.ingredients;
            this.showingConversion = true;
            this.message = data.message;
            this.messageType = 'success';

            // Scroll vers la section des ingrÃ©dients
            setTimeout(() => {
              const ingredientsSection = document.querySelector('section.mb-8:has(table)');
              if (ingredientsSection) {
                ingredientsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 300);
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de la conversion:', error);
          this.message = '{{ "Erreur lors de la conversion" if lang == "fr" else "å¤‰æ›ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.converting = false;
        }
      },

      resetConversion() {
        this.showingConversion = false;
        this.convertedIngredients = [];
        this.targetServings = this.originalServings;
        this.message = '';
      }
    }
  }
</script>
{% endblock %}