{% extends 'base.html' %}
{% block content %}
<article class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-3 sm:p-6 rounded" x-data="recipeDetail()">
  <!-- Bouton retour -->
  <div class="mb-4">
    {% if event_id %}
      <a href="/events/{{ event_id }}/organization?lang={{ lang }}"
         class="inline-flex items-center gap-2 px-3 py-2
                text-blue-600 dark:text-blue-400
                hover:bg-blue-50 dark:hover:bg-blue-900/20
                rounded-lg transition-colors duration-150">
        <span class="text-lg">â†</span>
        <span class="font-medium">{{ 'Retour Ã  l\'organisation' if lang == 'fr' else 'ä¼ç”»ã«æˆ»ã‚‹' }}</span>
      </a>
    {% else %}
      <a href="/recipes?lang={{ lang }}"
         class="inline-flex items-center gap-2 px-3 py-2
                text-blue-600 dark:text-blue-400
                hover:bg-blue-50 dark:hover:bg-blue-900/20
                rounded-lg transition-colors duration-150">
        <span class="text-lg">â†</span>
        <span class="font-medium">{{ 'Retour aux recettes' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ã«æˆ»ã‚‹' }}</span>
      </a>
    {% endif %}
  </div>

  <!-- En-tÃªte de la recette -->
  <header class="mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
    <div class="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
      <h1 class="text-2xl sm:text-3xl font-bold">{{ rec['name'] }}</h1>

      <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
        <!-- Bouton de modification -->
        <button
          @click="openEditModal()"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition-colors"
        >
          <span>âœï¸</span>
          <span>{{ 'ç·¨é›†' if lang == 'jp' else 'Modifier' }}</span>
        </button>

        <!-- Bouton de traduction/retraduction -->
        <button
          @click="translateRecipe()"
          :disabled="translating"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {% if lang == 'jp' %}
          <span x-show="!translating">{{ 'ğŸ”„ FR â†’ JP å†ç¿»è¨³' if has_translation else 'ğŸŒ FR â†’ JP ç¿»è¨³' }}</span>
          {% else %}
          <span x-show="!translating">{{ 'ğŸ”„ JP â†’ FR Retraduire' if has_translation else 'ğŸŒ JP â†’ FR Traduire' }}</span>
          {% endif %}
          <span x-show="translating">â³ {{ 'Traduction...' if lang == 'fr' else 'ç¿»è¨³ä¸­...' }}</span>
        </button>
      </div>
    </div>

    <!-- Description de la recette -->
    {% if rec.get('description') %}
    <div class="mt-4 mb-4 p-3 bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500 rounded">
      <p class="text-gray-800 dark:text-gray-200">{{ rec['description'] }}</p>
    </div>
    {% endif %}

    <div class="flex flex-wrap gap-3 sm:gap-4 text-xs sm:text-sm text-gray-700 dark:text-gray-300">
      <div>
        <span class="font-semibold">{{ S('servings') }}:</span>
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded">{{ rec['servings'] or '-' }}</span>
      </div>
      {% if rec['creator_username'] %}
      <div>
        <span class="font-semibold">ğŸ‘¤ {{ 'CrÃ©ateur' if lang == 'fr' else 'ä½œæˆè€…' }}:</span>
        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">{{ rec['creator_display_name'] or rec['creator_username'] }}</span>
      </div>
      {% endif %}
      {% if rec['source'] %}
      <div>
        <span class="font-semibold">{{ S('source') }}:</span>
        <a class="text-blue-600 hover:underline" href="{{ rec['source'] }}" target="_blank">lien</a>
      </div>
      {% endif %}
    </div>

    <!-- CatÃ©gories, Tags et Types d'Ã©vÃ©nements affichÃ©s -->
    <div class="mt-4 space-y-2">
      <!-- CatÃ©gories -->
      <div x-show="selectedCategories.length > 0" class="flex flex-wrap gap-2 items-center">
        <span class="text-sm font-semibold text-gray-700">
          {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼:' if lang == 'jp' else 'CatÃ©gories:' }}
        </span>
        <template x-for="catId in selectedCategories" :key="catId">
          <span
            x-data="{cat: categories.find(c => c.id === catId)}"
            x-show="cat"
            class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
            x-text="cat ? (lang === 'jp' ? cat.name_jp : cat.name_fr) : ''"></span>
        </template>
      </div>

      <!-- Types d'Ã©vÃ©nements -->
      <div x-show="selectedEventTypes.length > 0" class="flex flex-wrap gap-2 items-center">
        <span class="text-sm font-semibold text-gray-700">
          {{ 'ã‚¤ãƒ™ãƒ³ãƒˆ:' if lang == 'jp' else 'Ã‰vÃ©nements:' }}
        </span>
        <template x-for="eventTypeId in selectedEventTypes" :key="eventTypeId">
          <span
            x-data="{et: eventTypes.find(e => e.id === eventTypeId)}"
            x-show="et"
            class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium"
            x-text="et ? (lang === 'jp' ? et.name_jp : et.name_fr) : ''"></span>
        </template>
      </div>

      <!-- Tags -->
      <div x-show="selectedTags.length > 0" class="flex flex-wrap gap-2 items-center">
        <span class="text-sm font-semibold text-gray-700">
          {{ 'ã‚¿ã‚°:' if lang == 'jp' else 'Tags:' }}
        </span>
        <template x-for="tagId in selectedTags" :key="tagId">
          <span
            x-data="{tag: tags.find(t => t.id === tagId)}"
            x-show="tag"
            class="px-3 py-1 rounded-full text-sm font-medium"
            :style="tag ? `background-color: ${tag.color}20; color: ${tag.color}; border: 1px solid ${tag.color}` : ''"
            x-text="tag ? (lang === 'jp' ? tag.name_jp : tag.name_fr) : ''"></span>
        </template>
      </div>
    </div>
  </header>

  <!-- Message de statut -->
  <div x-show="message"
       x-transition
       :class="messageType === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'"
       class="border px-4 py-3 rounded mb-4"
       role="alert">
    <p x-text="message"></p>
  </div>

  <!-- Section Conversion de recette -->
  <section class="mb-8">
    <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/30 dark:to-blue-900/30 border border-green-200 dark:border-green-700 rounded-lg p-3 sm:p-4">
      <div class="flex flex-col gap-3 sm:gap-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
          <h3 class="text-base sm:text-lg font-bold text-green-900 dark:text-green-200 whitespace-nowrap">
            ğŸ§® {{ 'Conversion' if lang == 'fr' else 'åˆ†é‡å¤‰æ›' }}
          </h3>

          <div class="flex items-center gap-2 sm:gap-3">
            <label class="text-sm font-semibold text-gray-700 dark:text-gray-300 whitespace-nowrap">
              {{ 'Pers.:' if lang == 'fr' else 'äººæ•°:' }}
            </label>
            <div class="flex items-center gap-1.5 sm:gap-2">
              <button @click="targetServings = Math.max(1, targetServings - 1)"
                class="w-8 h-8 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 rounded-full font-bold transition">âˆ’</button>
              <input type="number" x-model.number="targetServings" min="1" max="50"
                class="w-14 sm:w-16 text-center px-1 sm:px-2 py-1 border rounded text-base">
              <button @click="targetServings = Math.min(50, targetServings + 1)"
                class="w-8 h-8 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 rounded-full font-bold transition">+</button>
            </div>
            <span class="text-xs text-gray-500 dark:text-gray-400">
              ({{ 'orig:' if lang == 'fr' else 'å…ƒ:' }} <strong x-text="originalServings"></strong>)
            </span>
          </div>
        </div>

        <div class="flex gap-2 sm:gap-3">
          <button @click="convertRecipe()" :disabled="converting || targetServings === originalServings"
            class="flex-1 sm:flex-none px-4 sm:px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap text-sm sm:text-base">
            <span x-show="!converting">{{ 'âœ¨ Convertir' if lang == 'fr' else 'âœ¨ å¤‰æ›' }}</span>
            <span x-show="converting">{{ 'â³ ...' if lang == 'fr' else 'â³ ...' }}</span>
          </button>
          <a :href="`/recipe/{{ slug }}/cost?lang={{ lang }}&servings=${targetServings}`"
            class="flex-1 sm:flex-none px-4 sm:px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition-colors whitespace-nowrap inline-flex items-center justify-center text-sm sm:text-base">
            {{ 'ğŸ’° CoÃ»t' if lang == 'fr' else 'ğŸ’° ã‚³ã‚¹ãƒˆ' }}
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Section IngrÃ©dients -->
  <section class="mb-8">
    <h2 class="text-xl font-bold mb-3">
      {{ S('ingredients') }}
      <span x-show="showingConversion" class="text-sm text-green-600 ml-2">
        ({{ 'pour' if lang == 'fr' else '' }} <span x-text="targetServings"></span> {{ 'personne(s)' if lang == 'fr' else 'äººåˆ†' }})
      </span>
      <button
        x-show="showingConversion"
        @click="resetConversion()"
        class="ml-3 text-sm text-blue-600 hover:underline"
      >
        {{ 'Afficher quantitÃ©s originales' if lang == 'fr' else 'å…ƒã®é‡ã‚’è¡¨ç¤º' }}
      </button>
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300 text-sm sm:text-base">
        <thead>
          <tr class="bg-gray-100 dark:bg-gray-700">
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-left font-semibold">{{ S('ingredients') }}</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center font-semibold w-16 sm:w-24">{{ 'QtÃ©' if lang == 'fr' else 'é‡' }}</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center font-semibold w-16 sm:w-24">{{ 'UnitÃ©' if lang == 'fr' else 'å˜ä½' }}</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-left font-semibold hidden sm:table-cell">{{ 'Commentaire' if lang == 'fr' else 'ã‚³ãƒ¡ãƒ³ãƒˆ' }}</th>
          </tr>
        </thead>
        <tbody>
          {% for ig in ings %}
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" x-show="!showingConversion">
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2">
              {{ ig['name'] or '-' }}
              {% if ig['notes'] %}
              <span class="block sm:hidden text-xs text-gray-500 dark:text-gray-400 mt-0.5">{{ ig['notes'] }}</span>
              {% endif %}
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center">
              {{ ig['quantity'] if ig['quantity'] is not none else '-' }}
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center">
              {{ ig['unit'] or '-' }}
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-gray-600 dark:text-gray-400 hidden sm:table-cell">
              {{ ig['notes'] or '-' }}
            </td>
          </tr>
          {% endfor %}

          <template x-for="ing in convertedIngredients" :key="ing.id">
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" x-show="showingConversion" :class="ing.is_negligible ? 'bg-yellow-50 dark:bg-yellow-900/20' : ''">
              <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2">
                <span x-text="ing.name"></span>
                <span x-show="ing.is_negligible" class="ml-1 text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded">
                  {{ 'nÃ©gligeable' if lang == 'fr' else 'ç„¡è¦–å¯èƒ½' }}
                </span>
                <span class="block sm:hidden text-xs text-gray-500 mt-0.5" x-show="ing.notes" x-text="ing.notes"></span>
              </td>
              <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center font-semibold text-green-700 dark:text-green-400">
                <span x-text="ing.converted_quantity !== null && ing.converted_quantity !== undefined ? ing.converted_quantity : '-'"></span>
              </td>
              <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-center">
                <span x-text="ing.purchase_unit || ing.unit || '-'"></span>
              </td>
              <td class="border border-gray-300 dark:border-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 text-gray-600 dark:text-gray-400 hidden sm:table-cell">
                <span x-text="ing.notes || '-'"></span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Section Ã‰tapes -->
  <section class="mb-8">
    <h2 class="text-xl font-bold mb-3">{{ S('steps') }}</h2>
    <ol class="space-y-3">
      {% for s in steps %}
      <li class="flex gap-3">
        <span class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-sm">
          {{ loop.index }}
        </span>
        <p class="flex-1 pt-1">{{ s['text'] }}</p>
      </li>
      {% endfor %}
    </ol>
  </section>

  <!-- Section Image et informations -->
  <section class="mb-8">
    <div class="flex flex-col md:flex-row gap-6 items-start">
      <!-- Affichage de l'image -->
      <div class="w-full md:w-1/2">
        <div class="relative group"
             @drop.prevent="handleDrop($event)"
             @dragover.prevent="isDragging = true"
             @dragleave.prevent="isDragging = false"
             :class="isDragging ? 'ring-4 ring-blue-500 ring-opacity-50' : ''">
          <img
            :src="recipeImage || '/static/images/recipe-placeholder.jpg'"
            alt="{{ rec['name'] }}"
            class="w-full rounded-lg shadow-md object-cover"
            style="max-height: 400px"
          >
          <!-- Overlay pour drag & drop -->
          <div x-show="isDragging" class="absolute inset-0 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
            <div class="text-white text-xl font-bold">
              ğŸ“¥ {{ 'DÃ©poser l\'image ici' if lang == 'fr' else 'ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—' }}
            </div>
          </div>
          <!-- Boutons d'action sur l'image (affichÃ©s au survol) -->
          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all rounded-lg flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100">
            <button
              @click="$refs.imageInput.click()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors shadow-lg"
            >
              ğŸ“· {{ 'Modifier' if lang == 'fr' else 'å¤‰æ›´' }}
            </button>
            <button
              x-show="recipeImage"
              @click="deleteImage()"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors shadow-lg"
            >
              ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
            </button>
          </div>
        </div>

        <!-- Input file cachÃ© -->
        <input
          type="file"
          x-ref="imageInput"
          @change="uploadImage($event)"
          accept="image/jpeg,image/png,image/webp"
          class="hidden"
        >

        <!-- Indicateur de chargement -->
        <div x-show="uploadingImage" class="mt-3 text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-sm text-gray-600">{{ 'Upload en cours...' if lang == 'fr' else 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' }}</p>
        </div>
      </div>

      <!-- Informations photo -->
      <div class="w-full md:w-1/2">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="font-semibold text-blue-900 mb-2">ğŸ“· {{ 'Photo de la recette' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”å†™çœŸ' }}</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>âœ“ {{ 'Formats acceptÃ©s: JPG, PNG, WebP, GIF' if lang == 'fr' else 'å¯¾å¿œå½¢å¼: JPGã€PNGã€WebPã€GIF' }}</li>
            <li>âœ“ {{ 'Taille max: 5 MB' if lang == 'fr' else 'æœ€å¤§ã‚µã‚¤ã‚º: 5 MB' }}</li>
            <li>âŒ¨ï¸ {{ 'Coller une image: Ctrl+V ou Cmd+V' if lang == 'fr' else 'ç”»åƒã‚’è²¼ã‚Šä»˜ã‘: Ctrl+V ã¾ãŸã¯ Cmd+V' }}</li>
            <li>ğŸ–±ï¸ {{ 'Ou glisser-dÃ©poser sur l\'image' if lang == 'fr' else 'ã¾ãŸã¯ç”»åƒã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—' }}</li>
            <li>ğŸ’¡ {{ 'Conseil: optimisez vos images avant upload' if lang == 'fr' else 'ãƒ’ãƒ³ãƒˆ: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«ç”»åƒã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„' }}</li>
          </ul>
          <p class="mt-3 text-sm text-gray-700">
            {{ 'Survolez l\'image pour afficher les options de modification.' if lang == 'fr' else 'ç”»åƒã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã¨ç·¨é›†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚' }}
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Section CatÃ©gories et Tags (affichage en bas de page) -->
  <section class="mb-8 p-6 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg border border-blue-200">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">
      {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°' if lang == 'jp' else 'Classification' }}
    </h2>

    <div class="space-y-4">
      <!-- CatÃ©gories -->
      <div x-show="selectedCategories.length > 0">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">
          {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' if lang == 'jp' else 'CatÃ©gories' }}
        </h3>
        <div class="flex flex-wrap gap-2">
          <template x-for="catId in selectedCategories" :key="catId">
            <div x-data="{cat: categories.find(c => c.id === catId)}" x-show="cat">
              <span class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-full text-sm font-medium shadow-md">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                <span x-text="cat ? (lang === 'jp' ? cat.name_jp : cat.name_fr) : ''"></span>
              </span>
            </div>
          </template>
        </div>
        <div x-show="selectedCategories.length === 0" class="text-sm text-gray-500 italic">
          {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ãªã—' if lang == 'jp' else 'Aucune catÃ©gorie dÃ©finie' }}
        </div>
      </div>

      <!-- Tags -->
      <div>
        <h3 class="text-sm font-semibold text-gray-700 mb-2">
          {{ 'ã‚¿ã‚°' if lang == 'jp' else 'Tags' }}
        </h3>
        <div x-show="selectedTags.length > 0" class="flex flex-wrap gap-2">
          <template x-for="tagId in selectedTags" :key="tagId">
            <div x-data="{tag: tags.find(t => t.id === tagId)}" x-show="tag">
              <span
                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium shadow-sm"
                :style="tag ? `background-color: ${tag.color}; color: white` : ''"
              >
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                <span x-text="tag ? (lang === 'jp' ? tag.name_jp : tag.name_fr) : ''"></span>
              </span>
            </div>
          </template>
        </div>
        <div x-show="selectedTags.length === 0" class="text-sm text-gray-500 italic">
          {{ 'ã‚¿ã‚°ãªã—' if lang == 'jp' else 'Aucun tag dÃ©fini' }}
        </div>
      </div>
    </div>

    <!-- Bouton pour ouvrir le modal et modifier -->
    <div class="mt-4 pt-4 border-t border-blue-300">
      <button
        @click="openEditModal()"
        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm flex items-center gap-2"
      >
        <span>âœï¸</span>
        <span>{{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã‚’ç·¨é›†' if lang == 'jp' else 'Modifier les catÃ©gories et tags' }}</span>
      </button>
    </div>
  </section>

  <!-- Bouton retour -->
  <div class="mt-8 pt-4 border-t">
    <a href="/recipes?lang={{ lang }}" class="text-blue-600 hover:underline">
      â† {{ S('back') if S('back') != 'back' else 'Retour' }}
    </a>
  </div>

  <!-- Modal de modification -->
  <div x-show="editMode"
       x-cloak
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
       @click.self="closeEditModal()">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto p-3 sm:p-6">
      <!-- En-tÃªte du modal -->
      <div class="flex justify-between items-center mb-4 sm:mb-6 pb-3 sm:pb-4 border-b border-gray-200 dark:border-gray-600">
        <h2 class="text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">{{ 'ãƒ¬ã‚·ãƒ”ã®ç·¨é›†' if lang == 'jp' else 'Modification de la recette' }}</h2>
        <button @click="closeEditModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl p-1">
          Ã—
        </button>
      </div>

      <!-- Section Informations gÃ©nÃ©rales -->
      <div class="mb-6 sm:mb-8 p-3 sm:p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-gray-900 dark:text-gray-100">{{ 'åŸºæœ¬æƒ…å ±' if lang == 'jp' else 'Informations gÃ©nÃ©rales' }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-200">
              {{ 'ã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Type de recette' }}
            </label>
            <input
              type="text"
              x-model="editData.recipe_type"
              placeholder="{{ 'ã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Ex: Plat principal, Dessert...' }}"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-200">
              {{ 'äººæ•°' if lang == 'jp' else 'Nombre de personnes' }}
            </label>
            <input
              type="number"
              min="1"
              x-model="editData.servings_default"
              placeholder="{{ 'äººæ•°' if lang == 'jp' else 'Ex: 4' }}"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-200">
              ğŸ‘¤ {{ 'ä½œæˆè€…' if lang == 'jp' else 'CrÃ©ateur' }}
            </label>
            <select
              x-model="editData.user_id"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
            >
              <option value="">{{ 'é¸æŠã—ã¦ãã ã•ã„' if lang == 'jp' else 'SÃ©lectionner...' }}</option>
              {% for user in all_users %}
              <option value="{{ user.id }}">{{ user.display_name or user.username }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Description -->
        <div class="mt-3 sm:mt-4">
          <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-200">
            {{ 'èª¬æ˜' if lang == 'jp' else 'Description' }}
          </label>
          <textarea
            x-model="editData.description"
            rows="3"
            placeholder="{{ 'çŸ­ã„èª¬æ˜ï¼ˆ1ã€œ2æ–‡ï¼‰' if lang == 'jp' else 'Courte description (1-2 phrases)' }}"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 resize-y"
          ></textarea>
        </div>
      </div>

      <!-- Section CatÃ©gories et Tags -->
      <div class="mb-6 sm:mb-8 p-3 sm:p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-gray-900 dark:text-gray-100">
          {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°' if lang == 'jp' else 'CatÃ©gories et Tags' }}
        </h3>

        <!-- CatÃ©gories -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">
            {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' if lang == 'jp' else 'CatÃ©gories' }}
          </label>
          <div class="space-y-2">
            <template x-for="category in categories" :key="category.id">
              <label
                class="flex items-center cursor-pointer p-3 rounded-lg transition-all select-none"
                :class="selectedCategories.includes(category.id) ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 border-2 border-gray-200 hover:bg-gray-100'"
              >
                <input
                  type="checkbox"
                  :value="category.id"
                  x-model="selectedCategories"
                  class="mr-3 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                />
                <div class="flex-1">
                  <div
                    class="font-medium"
                    :class="selectedCategories.includes(category.id) ? 'text-blue-900' : 'text-gray-900'"
                    x-text="lang === 'jp' ? category.name_jp : category.name_fr"
                  ></div>
                  <div class="text-xs text-gray-500" x-text="lang === 'jp' ? category.description_jp : category.description_fr"></div>
                </div>
                <svg x-show="selectedCategories.includes(category.id)" class="w-5 h-5 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </label>
            </template>
          </div>
        </div>

        <!-- Types d'Ã©vÃ©nements -->
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">
            {{ 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Types d\'Ã©vÃ©nements' }}
          </label>
          <div class="space-y-2">
            <template x-for="eventType in eventTypes" :key="eventType.id">
              <label
                class="flex items-center cursor-pointer p-3 rounded-lg transition-all select-none"
                :class="selectedEventTypes.includes(eventType.id) ? 'bg-purple-100 border-2 border-purple-500' : 'bg-gray-50 border-2 border-gray-200 hover:bg-gray-100'"
              >
                <input
                  type="checkbox"
                  :value="eventType.id"
                  x-model="selectedEventTypes"
                  class="mr-3 w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                />
                <div class="flex-1">
                  <div
                    class="font-medium"
                    :class="selectedEventTypes.includes(eventType.id) ? 'text-purple-900' : 'text-gray-900'"
                    x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr"
                  ></div>
                  <div class="text-xs text-gray-500" x-text="lang === 'jp' ? eventType.description_jp : eventType.description_fr"></div>
                </div>
                <svg x-show="selectedEventTypes.includes(eventType.id)" class="w-5 h-5 text-purple-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </label>
            </template>
          </div>
        </div>

        <!-- Tags -->
        <div>
          <label class="block text-sm font-semibold mb-2">
            {{ 'ã‚¿ã‚°' if lang == 'jp' else 'Tags' }}
          </label>
          <div class="flex flex-wrap gap-2">
            <template x-for="tag in tags" :key="tag.id">
              <button
                type="button"
                @click="toggleTag(tag.id)"
                class="inline-flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all select-none"
                :class="selectedTags.includes(tag.id) ? 'ring-2 ring-offset-2 opacity-100 scale-105' : 'opacity-70 hover:opacity-90 hover:scale-105'"
                :style="selectedTags.includes(tag.id) ?
                  `background-color: ${tag.color}; color: white; border: 2px solid ${tag.color}; font-weight: 600` :
                  `background-color: ${tag.color}20; color: ${tag.color}; border: 2px solid ${tag.color}60`"
              >
                <span class="text-sm" x-text="lang === 'jp' ? tag.name_jp : tag.name_fr"></span>
              </button>
            </template>
          </div>
        </div>
      </div>

      <!-- Section IngrÃ©dients -->
      <div class="mb-6 sm:mb-8">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100">{{ S('ingredients') }}</h3>
          <button
            @click="addIngredient()"
            type="button"
            class="px-3 sm:px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold transition-colors text-sm sm:text-base"
          >
            + {{ 'Ajouter' if lang == 'fr' else 'è¿½åŠ ' }}
          </button>
        </div>
        <div class="space-y-2">
          <template x-for="(ing, index) in editData.ingredients" :key="index">
            <div class="border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
              <!-- Desktop: grille horizontale -->
              <div class="hidden sm:grid grid-cols-12 gap-2 items-center p-2">
                <div class="col-span-1 flex flex-col gap-1 items-center">
                  <button @click="moveIngredientUp(index)" type="button" :disabled="index === 0"
                    class="px-2 py-1 text-gray-600 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed"
                    title="{{ 'ä¸Šã¸' if lang == 'jp' else 'Monter' }}">â–²</button>
                  <button @click="moveIngredientDown(index)" type="button" :disabled="index === editData.ingredients.length - 1"
                    class="px-2 py-1 text-gray-600 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed"
                    title="{{ 'ä¸‹ã¸' if lang == 'jp' else 'Descendre' }}">â–¼</button>
                </div>
                <div class="col-span-3">
                  <input type="text" x-model="ing.name" placeholder="{{ 'Nom' if lang == 'fr' else 'åå‰' }}"
                    class="w-full px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" />
                </div>
                <div class="col-span-2">
                  <input type="number" step="0.01" x-model="ing.quantity" placeholder="{{ 'QtÃ©' if lang == 'fr' else 'é‡' }}"
                    class="w-full px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" />
                </div>
                <div class="col-span-2">
                  <input type="text" x-model="ing.unit" placeholder="{{ 'UnitÃ©' if lang == 'fr' else 'å˜ä½' }}"
                    class="w-full px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" />
                </div>
                <div class="col-span-3">
                  <input type="text" x-model="ing.notes" placeholder="{{ 'Notes' if lang == 'fr' else 'å‚™è€ƒ' }}"
                    class="w-full px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" />
                </div>
                <div class="col-span-1 flex flex-col gap-1">
                  <button @click="addIngredientAt(index + 1)" type="button"
                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-semibold transition-colors"
                    title="{{ 'å¾Œã«è¿½åŠ ' if lang == 'jp' else 'InsÃ©rer aprÃ¨s' }}">+</button>
                  <button @click="removeIngredient(index)" type="button"
                    class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold transition-colors">âœ•</button>
                </div>
              </div>

              <!-- Mobile: layout empilÃ© -->
              <div class="sm:hidden p-3">
                <div class="flex items-start gap-2">
                  <div class="flex flex-col gap-1 pt-1">
                    <button @click="moveIngredientUp(index)" type="button" :disabled="index === 0"
                      class="px-1.5 py-0.5 text-gray-600 dark:text-gray-300 hover:text-blue-600 disabled:opacity-30 text-sm">â–²</button>
                    <button @click="moveIngredientDown(index)" type="button" :disabled="index === editData.ingredients.length - 1"
                      class="px-1.5 py-0.5 text-gray-600 dark:text-gray-300 hover:text-blue-600 disabled:opacity-30 text-sm">â–¼</button>
                  </div>
                  <div class="flex-1 space-y-2">
                    <input type="text" x-model="ing.name" placeholder="{{ 'Nom' if lang == 'fr' else 'åå‰' }}"
                      class="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 text-base" />
                    <div class="grid grid-cols-2 gap-2">
                      <input type="number" step="0.01" x-model="ing.quantity" placeholder="{{ 'QtÃ©' if lang == 'fr' else 'é‡' }}"
                        class="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 text-base" />
                      <input type="text" x-model="ing.unit" placeholder="{{ 'UnitÃ©' if lang == 'fr' else 'å˜ä½' }}"
                        class="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 text-base" />
                    </div>
                    <input type="text" x-model="ing.notes" placeholder="{{ 'Notes' if lang == 'fr' else 'å‚™è€ƒ' }}"
                      class="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 text-base" />
                  </div>
                  <div class="flex flex-col gap-1 pt-1">
                    <button @click="addIngredientAt(index + 1)" type="button"
                      class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-semibold">+</button>
                    <button @click="removeIngredient(index)" type="button"
                      class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold">âœ•</button>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Section Ã‰tapes -->
      <div class="mb-6 sm:mb-8">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100">{{ S('steps') }}</h3>
          <button
            @click="addStep()"
            type="button"
            class="px-3 sm:px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold transition-colors text-sm sm:text-base"
          >
            + {{ 'Ajouter' if lang == 'fr' else 'è¿½åŠ ' }}
          </button>
        </div>
        <div class="space-y-3">
          <template x-for="(step, index) in editData.steps" :key="index">
            <div class="border border-gray-300 dark:border-gray-600 rounded p-2 sm:p-3 bg-white dark:bg-gray-700">
              <div class="flex gap-2 sm:gap-3 items-start">
                <!-- NumÃ©ro et contrÃ´les d'ordre -->
                <div class="flex-shrink-0 flex flex-col items-center gap-1 sm:gap-2">
                  <button @click="moveStepUp(index)" type="button" :disabled="index === 0"
                    class="px-1.5 sm:px-2 py-1 text-gray-600 dark:text-gray-300 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed text-sm">â–²</button>
                  <span class="w-7 h-7 sm:w-8 sm:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm" x-text="index + 1"></span>
                  <button @click="moveStepDown(index)" type="button" :disabled="index === editData.steps.length - 1"
                    class="px-1.5 sm:px-2 py-1 text-gray-600 dark:text-gray-300 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed text-sm">â–¼</button>
                </div>

                <!-- Texte de l'Ã©tape -->
                <textarea
                  x-model="step.text"
                  rows="3"
                  class="flex-1 px-2 sm:px-3 py-2 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100 resize-y text-base"
                  :placeholder="'{{ 'Ã‰tape' if lang == 'fr' else 'ã‚¹ãƒ†ãƒƒãƒ—' }} ' + (index + 1)"
                ></textarea>

                <!-- Boutons d'action -->
                <div class="flex-shrink-0 flex flex-col gap-1 sm:gap-2">
                  <button @click="addStepAt(index + 1)" type="button"
                    class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-500 hover:bg-blue-600 text-white rounded font-semibold transition-colors text-xs sm:text-sm">+</button>
                  <button @click="removeStep(index)" type="button"
                    class="px-2 sm:px-3 py-1.5 sm:py-2 bg-red-500 hover:bg-red-600 text-white rounded font-semibold transition-colors text-xs sm:text-sm">âœ•</button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
        <button
          @click="closeEditModal()"
          class="w-full sm:w-auto px-6 py-2.5 sm:py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded font-semibold transition-colors text-base"
        >
          {{ 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' if lang == 'jp' else 'Annuler' }}
        </button>
        <button
          @click="saveRecipe()"
          :disabled="saving"
          class="w-full sm:w-auto px-6 py-2.5 sm:py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold disabled:opacity-50 transition-colors text-base"
        >
          <span x-show="!saving">{{ 'ä¿å­˜' if lang == 'jp' else 'Enregistrer' }}</span>
          <span x-show="saving">{{ 'ä¿å­˜ä¸­...' if lang == 'jp' else 'Enregistrement...' }}</span>
        </button>
      </div>
    </div>
  </div>
</article>

<style>
  [x-cloak] { display: none !important; }
</style>

<script>
  function recipeDetail() {
    return {
      apiStatus: 'checking',
      translating: false,
      message: '',
      messageType: 'info',
      editMode: false,
      saving: false,
      uploadingImage: false,
      isDragging: false,
      recipeImage: '{{ rec["image_url"] or "" }}',
      editData: {
        ingredients: [],
        steps: []
      },
      originalData: null,
      // Conversion
      originalServings: {{ rec['servings'] or 1 }},
      targetServings: {{ rec['servings'] or 1 }},
      converting: false,
      showingConversion: false,
      convertedIngredients: [],
      // CatÃ©gories et tags
      categories: [],
      tags: [],
      eventTypes: [],
      selectedCategories: [],
      selectedTags: [],
      selectedEventTypes: [],
      lang: '{{ lang }}',

      async init() {
        // VÃ©rifier le statut de l'API pour la traduction/retraduction
        await this.checkApiStatus();
        // Charger les catÃ©gories et tags
        await this.loadCategoriesAndTags();
        // Initialiser les donnÃ©es d'Ã©dition
        this.initEditData();
        // Ajouter le listener pour le copier-coller d'images
        this.setupPasteListener();
      },

      setupPasteListener() {
        document.addEventListener('paste', (event) => {
          const items = (event.clipboardData || event.originalEvent.clipboardData).items;
          for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
              const file = item.getAsFile();
              this.uploadImageFile(file);
              event.preventDefault();
              break;
            }
          }
        });
      },

      initEditData() {
        // RÃ©cupÃ©rer les donnÃ©es actuelles depuis le DOM
        this.originalData = {
          ingredients: {{ ings | tojson | safe }},
          steps: {{ steps | tojson | safe }},
          recipe_type: '{{ rec["type"] or "" }}',
          servings_default: {{ rec['servings'] or 'null' }},
          user_id: {{ rec['user_id'] or 'null' }},
          description: '{{ rec.get("description", "") | replace("'", "\\'") | replace("\n", "\\n") }}'
        };
      },

      async checkApiStatus() {
        try {
          const response = await fetch('/api/translation/status');
          const data = await response.json();
          this.apiStatus = data.status;
        } catch (error) {
          console.error('Erreur lors de la vÃ©rification du statut API:', error);
          this.apiStatus = 'error';
        }
      },

      async loadCategoriesAndTags() {
        try {
          // Charger toutes les catÃ©gories, tags et types d'Ã©vÃ©nements disponibles
          const [categoriesRes, tagsRes, eventTypesRes] = await Promise.all([
            fetch('/api/categories'),
            fetch('/api/tags'),
            fetch('/api/event-types')
          ]);

          this.categories = await categoriesRes.json();
          this.tags = await tagsRes.json();
          this.eventTypes = await eventTypesRes.json();

          console.log('âœ… CatÃ©gories chargÃ©es:', this.categories.length);
          console.log('âœ… Tags chargÃ©s:', this.tags.length);
          console.log('âœ… Types d\'Ã©vÃ©nements chargÃ©s:', this.eventTypes.length);

          // Si on affiche une recette existante, charger ses catÃ©gories, tags et types d'Ã©vÃ©nements
          const recipeId = {{ rec['id'] or 'null' }};
          if (recipeId) {
            const [recipeCatsRes, recipeTagsRes, recipeEventTypesRes] = await Promise.all([
              fetch(`/api/recipes/${recipeId}/categories`),
              fetch(`/api/recipes/${recipeId}/tags`),
              fetch(`/api/recipes/${recipeId}/event-types`)
            ]);

            const recipeCats = await recipeCatsRes.json();
            const recipeTags = await recipeTagsRes.json();
            const recipeEventTypes = await recipeEventTypesRes.json();

            this.selectedCategories = recipeCats.map(c => c.id);
            this.selectedTags = recipeTags.map(t => t.id);
            this.selectedEventTypes = recipeEventTypes.map(et => et.id);
          }
        } catch (error) {
          console.error('Erreur lors du chargement des catÃ©gories/tags/event types:', error);
        }
      },

      async translateRecipe() {
        const hasTranslation = {{ 'true' if has_translation else 'false' }};

        // Confirmer la retraduction si la traduction existe dÃ©jÃ 
        if (hasTranslation) {
          {% if lang == 'jp' %}
          const confirmMessage = 'âš ï¸ æ³¨æ„ âš ï¸\n\n' +
            'ãƒ•ãƒ©ãƒ³ã‚¹èªç‰ˆã‹ã‚‰æ—¥æœ¬èªç‰ˆã«å†ç¿»è¨³ã—ã¾ã™ã€‚\n' +
            'ç¾åœ¨ã®æ—¥æœ¬èªç‰ˆã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚\n\n' +
            'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
          {% else %}
          const confirmMessage = 'âš ï¸ ATTENTION âš ï¸\n\n' +
            'Vous allez REMPLACER la version franÃ§aise par une retraduction depuis le japonais.\n' +
            'La version franÃ§aise actuelle sera complÃ¨tement Ã‰CRASÃ‰E.\n\n' +
            'ÃŠtes-vous sÃ»r de vouloir continuer ?';
          {% endif %}
          if (!confirm(confirmMessage)) {
            return;
          }
        }

        this.translating = true;
        this.message = '';

        try {
          // Utiliser l'endpoint de traduction (qui gÃ¨re aussi la retraduction)
          const response = await fetch('/api/translate/{{ rec["slug"] }}?target_lang={{ lang }}', {
            method: 'POST'
          });

          const data = await response.json();

          if (data.success) {
            this.message = data.message;
            this.messageType = 'success';

            // Recharger la page aprÃ¨s 2 secondes pour afficher la traduction
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            this.message = data.message;
            this.messageType = 'error';
            this.translating = false;
          }
        } catch (error) {
          console.error('Erreur lors de la traduction:', error);
          this.message = 'Erreur lors de la communication avec le serveur';
          this.messageType = 'error';
          this.translating = false;
        }
      },

      openEditModal() {
        // CrÃ©er une copie profonde des donnÃ©es originales
        this.editData = {
          ingredients: JSON.parse(JSON.stringify(this.originalData.ingredients)),
          steps: JSON.parse(JSON.stringify(this.originalData.steps)),
          recipe_type: this.originalData.recipe_type,
          servings_default: this.originalData.servings_default,
          description: this.originalData.description || '',
          user_id: this.originalData.user_id || null
        };
        this.editMode = true;
        this.message = '';
      },

      closeEditModal() {
        // Fermer le modal sans sauvegarder
        this.editMode = false;
        this.editData = {
          ingredients: [],
          steps: []
        };
      },

      toggleTag(tagId) {
        const index = this.selectedTags.indexOf(tagId);
        if (index > -1) {
          // Tag dÃ©jÃ  sÃ©lectionnÃ©, on le retire
          this.selectedTags.splice(index, 1);
        } else {
          // Tag non sÃ©lectionnÃ©, on l'ajoute
          this.selectedTags.push(tagId);
        }
        console.log('Tags sÃ©lectionnÃ©s:', this.selectedTags);
      },

      async saveRecipe() {
        this.saving = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}?lang={{ lang }}', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ingredients: this.editData.ingredients,
              steps: this.editData.steps,
              recipe_type: this.editData.recipe_type,
              servings_default: this.editData.servings_default,
              user_id: this.editData.user_id,
              description: this.editData.description
            })
          });

          const data = await response.json();

          if (data.success) {
            // Sauvegarder les catÃ©gories, tags et types d'Ã©vÃ©nements
            const recipeId = {{ rec['id'] or 'null' }};
            if (recipeId) {
              await Promise.all([
                fetch(`/api/recipes/${recipeId}/categories`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ category_ids: this.selectedCategories })
                }),
                fetch(`/api/recipes/${recipeId}/tags`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ tag_ids: this.selectedTags })
                }),
                fetch(`/api/recipes/${recipeId}/event-types`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ event_type_ids: this.selectedEventTypes })
                })
              ]);
            }

            this.message = data.message;
            this.messageType = 'success';
            this.editMode = false;

            // Recharger la page aprÃ¨s 1 seconde pour afficher les modifications
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            this.message = data.message;
            this.messageType = 'error';
            this.saving = false;
          }
        } catch (error) {
          console.error('Erreur lors de la sauvegarde:', error);
          this.message = 'Erreur lors de la communication avec le serveur';
          this.messageType = 'error';
          this.saving = false;
        }
      },

      async uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        await this.uploadImageFile(file);
        // RÃ©initialiser l'input file
        event.target.value = '';
      },

      handleDrop(event) {
        this.isDragging = false;
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          this.uploadImageFile(files[0]);
        }
      },

      async uploadImageFile(file) {
        if (!file) return;

        // VÃ©rifier la taille (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          this.message = '{{ "Fichier trop volumineux (max 5 MB)" if lang == "fr" else "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§5 MBï¼‰" }}';
          this.messageType = 'error';
          return;
        }

        // VÃ©rifier le type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          this.message = '{{ "Format non supportÃ©. Utilisez JPG, PNG, WebP ou GIF" if lang == "fr" else "éå¯¾å¿œã®å½¢å¼ã§ã™ã€‚JPGã€PNGã€WebPã€GIFã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" }}';
          this.messageType = 'error';
          return;
        }

        this.uploadingImage = true;
        this.message = '';

        try {
          const formData = new FormData();
          formData.append('file', file);

          const response = await fetch('/api/recipe/{{ rec["slug"] }}/image', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            this.recipeImage = data.image_url;
            this.message = data.message;
            this.messageType = 'success';
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de l\'upload:', error);
          this.message = '{{ "Erreur lors de l\\'upload" if lang == "fr" else "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.uploadingImage = false;
        }
      },

      async deleteImage() {
        if (!confirm('{{ "ÃŠtes-vous sÃ»r de vouloir supprimer cette image ?" if lang == "fr" else "ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" }}')) {
          return;
        }

        this.uploadingImage = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}/image', {
            method: 'DELETE'
          });

          const data = await response.json();

          if (data.success) {
            this.recipeImage = '';
            this.message = data.message;
            this.messageType = 'success';
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de la suppression:', error);
          this.message = '{{ "Erreur lors de la suppression" if lang == "fr" else "å‰Šé™¤ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.uploadingImage = false;
        }
      },

      async convertRecipe() {
        this.converting = true;
        this.message = '';

        try {
          const response = await fetch('/api/recipe/{{ rec["slug"] }}/convert?lang={{ lang }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              target_servings: this.targetServings
            })
          });

          const data = await response.json();

          if (data.success) {
            this.convertedIngredients = data.ingredients;
            this.showingConversion = true;
            this.message = data.message;
            this.messageType = 'success';

            // Scroll vers la section des ingrÃ©dients
            setTimeout(() => {
              const ingredientsSection = document.querySelector('section.mb-8:has(table)');
              if (ingredientsSection) {
                ingredientsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 300);
          } else {
            this.message = data.message;
            this.messageType = 'error';
          }
        } catch (error) {
          console.error('Erreur lors de la conversion:', error);
          this.message = '{{ "Erreur lors de la conversion" if lang == "fr" else "å¤‰æ›ã‚¨ãƒ©ãƒ¼" }}';
          this.messageType = 'error';
        } finally {
          this.converting = false;
        }
      },

      resetConversion() {
        this.showingConversion = false;
        this.convertedIngredients = [];
        this.targetServings = this.originalServings;
        this.message = '';
      },

      // Gestion des ingrÃ©dients
      addIngredient() {
        this.editData.ingredients.push({
          id: null,
          name: '',
          quantity: null,
          unit: '',
          notes: ''
        });
      },

      addIngredientAt(index) {
        this.editData.ingredients.splice(index, 0, {
          id: null,
          name: '',
          quantity: null,
          unit: '',
          notes: ''
        });
      },

      removeIngredient(index) {
        if (confirm('{{ 'ã“ã®ææ–™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' if lang == 'jp' else 'Supprimer cet ingrÃ©dient ?' }}')) {
          this.editData.ingredients.splice(index, 1);
        }
      },

      moveIngredientUp(index) {
        if (index > 0) {
          const temp = this.editData.ingredients[index];
          this.editData.ingredients[index] = this.editData.ingredients[index - 1];
          this.editData.ingredients[index - 1] = temp;
        }
      },

      moveIngredientDown(index) {
        if (index < this.editData.ingredients.length - 1) {
          const temp = this.editData.ingredients[index];
          this.editData.ingredients[index] = this.editData.ingredients[index + 1];
          this.editData.ingredients[index + 1] = temp;
        }
      },

      // Gestion des Ã©tapes
      addStep() {
        this.editData.steps.push({
          id: null,
          text: ''
        });
      },

      addStepAt(index) {
        this.editData.steps.splice(index, 0, {
          id: null,
          text: ''
        });
      },

      removeStep(index) {
        if (confirm('{{ 'ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' if lang == 'jp' else 'Supprimer cette Ã©tape ?' }}')) {
          this.editData.steps.splice(index, 1);
        }
      },

      moveStepUp(index) {
        if (index > 0) {
          const temp = this.editData.steps[index];
          this.editData.steps[index] = this.editData.steps[index - 1];
          this.editData.steps[index - 1] = temp;
        }
      },

      moveStepDown(index) {
        if (index < this.editData.steps.length - 1) {
          const temp = this.editData.steps[index];
          this.editData.steps[index] = this.editData.steps[index + 1];
          this.editData.steps[index + 1] = temp;
        }
      }
    }
  }
</script>
{% endblock %}