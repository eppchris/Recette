{% extends 'base.html' %}

{% block breadcrumb %}{{ S('all') }}{% endblock %}

{% block content %}

<script>
  // DonnÃ©es des recettes pour Alpine
  window.recipesData = {{ rows | tojson | safe }};
</script>

<div x-data="{
  search: '',
  typeFilter: '',
  sortBy: 'name',
  sortOrder: 'asc',
  recipes: window.recipesData || [],
  deleteModal: false,
  recipeToDelete: null,
  get availableTypes() {
    const types = [...new Set(this.recipes.map(r => r.type).filter(t => t))];
    return types.sort();
  },
  get filteredRecipes() {
    let filtered = this.recipes.filter(r => {
      const matchesSearch = this.search === '' || r.name.toLowerCase().includes(this.search.toLowerCase());
      const matchesType = this.typeFilter === '' || r.type === this.typeFilter;
      return matchesSearch && matchesType;
    });
    return filtered.sort((a, b) => {
      let aVal = a[this.sortBy] || '';
      let bVal = b[this.sortBy] || '';
      if (this.sortBy === 'servings') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      if (this.sortOrder === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
  },
  sort(column) {
    if (this.sortBy === column) {
      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortBy = column;
      this.sortOrder = 'asc';
    }
  },
  confirmDelete(recipe) {
    this.recipeToDelete = recipe;
    this.deleteModal = true;
  },
  async deleteRecipe() {
    if (!this.recipeToDelete) return;

    try {
      const response = await fetch(`/api/recipe/${this.recipeToDelete.slug}?lang={{ lang }}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        // Supprimer de la liste locale
        this.recipes = this.recipes.filter(r => r.id !== this.recipeToDelete.id);
        this.deleteModal = false;
        this.recipeToDelete = null;
      } else {
        alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
    }
  },
  cancelDelete() {
    this.deleteModal = false;
    this.recipeToDelete = null;
  }
}">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">{{ S('all') }}</h1>
    <a href="/import?lang={{ lang }}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      {{ S('import') }}
    </a>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="mb-4 flex gap-4">
    <input
      type="text"
      x-model="search"
      placeholder="ğŸ” {{ 'Rechercher une recette...' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢...' }}"
      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    >
    <select
      x-model="typeFilter"
      class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white min-w-[200px]"
    >
      <option value="">{{ 'Tous les types' if lang == 'fr' else 'ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—' }}</option>
      <template x-for="type in availableTypes" :key="type">
        <option :value="type" x-text="type"></option>
      </template>
    </select>
  </div>

  <!-- Grille de cartes de recettes -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    <template x-for="r in filteredRecipes" :key="r.id">
      <div class="bg-white rounded-lg border overflow-hidden hover:shadow-lg transition-shadow">
        <!-- Image -->
        <a :href="`/recipe/${r.slug}?lang={{ lang }}`" class="block relative pb-[75%] overflow-hidden bg-gray-100">
          <img
            :src="r.thumbnail_url || '/static/images/recipe-placeholder.jpg'"
            :alt="r.name"
            class="absolute inset-0 w-full h-full object-cover"
          >
        </a>

        <!-- Contenu -->
        <div class="p-4">
          <a :href="`/recipe/${r.slug}?lang={{ lang }}`" class="block">
            <h3 class="font-semibold text-lg mb-2 hover:text-blue-600 transition" x-text="r.name"></h3>
          </a>

          <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
            <span x-text="r.type || '-'"></span>
            <span x-show="r.servings">ğŸ‘¥ <span x-text="r.servings"></span></span>
          </div>

          <!-- Actions -->
          <button
            @click="confirmDelete(r)"
            class="w-full text-red-600 hover:text-red-800 hover:bg-red-50 py-2 rounded transition text-sm"
          >
            ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
          </button>
        </div>
      </div>
    </template>

    <!-- Message si aucun rÃ©sultat -->
    <div x-show="filteredRecipes.length === 0" class="col-span-full p-12 text-center text-gray-500">
      <div class="text-6xl mb-4">ğŸ”</div>
      <div class="text-xl">{{ 'Aucune recette trouvÃ©e' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }}</div>
    </div>
  </div>

  {% if not rows %}
  <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm">
    {{ 'Aucune recette trouvÃ©e.' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }}
    <a href="/import?lang={{ lang }}" class="text-blue-700 underline">
      {{ 'Importez-en une !' if lang == 'fr' else 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼' }}
    </a>
  </div>
  {% endif %}

  <!-- Modal de confirmation de suppression -->
  <div
    x-show="deleteModal"
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="cancelDelete()"
  >
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
      <h2 class="text-xl font-bold mb-4">
        {{ 'Confirmer la suppression' if lang == 'fr' else 'å‰Šé™¤ã®ç¢ºèª' }}
      </h2>
      <p class="mb-6 text-gray-700">
        {{ 'ÃŠtes-vous sÃ»r de vouloir supprimer cette recette ?' if lang == 'fr' else 'ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' }}
      </p>
      <p class="mb-6 font-semibold text-gray-900" x-text="recipeToDelete?.name"></p>
      <div class="flex gap-3 justify-end">
        <button
          @click="cancelDelete()"
          class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
        >
          {{ 'Non' if lang == 'fr' else 'ã„ã„ãˆ' }}
        </button>
        <button
          @click="deleteRecipe()"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
        >
          {{ 'Oui, supprimer' if lang == 'fr' else 'ã¯ã„ã€å‰Šé™¤' }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}