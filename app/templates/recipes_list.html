{% extends 'base.html' %}

{% block breadcrumb %}{{ S('all') }}{% endblock %}

{% block content %}

<script>
  // DonnÃ©es des recettes pour Alpine
  window.recipesData = {{ rows | tojson | safe }};
</script>

<div x-data="{
  lang: '{{ lang }}',
  search: '',
  sortBy: 'name',
  sortOrder: 'asc',
  recipes: window.recipesData || [],
  categories: [],
  tags: [],
  eventTypes: [],
  selectedCategories: [],
  selectedTags: [],
  selectedEventTypeId: null,
  showCategories: false,
  showTags: false,
  deleteModal: false,
  recipeToDelete: null,

  async init() {
    await this.loadCategoriesTagsAndEventTypes();
  },

  async loadCategoriesTagsAndEventTypes() {
    try {
      const [categoriesRes, tagsRes, eventTypesRes] = await Promise.all([
        fetch('/api/categories'),
        fetch('/api/tags'),
        fetch('/api/event-types')
      ]);
      this.categories = await categoriesRes.json();
      this.tags = await tagsRes.json();
      this.eventTypes = await eventTypesRes.json();
    } catch (error) {
      console.error('Erreur chargement catÃ©gories/tags/event types:', error);
    }
  },

  get filteredRecipes() {
    let filtered = this.recipes.filter(r => {
      // Filtre de recherche textuelle
      const matchesSearch = this.search === '' || r.name.toLowerCase().includes(this.search.toLowerCase());

      // Filtre par type d'Ã©vÃ©nement
      let matchesEventType = this.selectedEventTypeId === null;
      if (!matchesEventType && r.event_types) {
        matchesEventType = r.event_types.some(et => et.id === this.selectedEventTypeId);
      }

      // Filtre par catÃ©gories (si des catÃ©gories sont sÃ©lectionnÃ©es)
      let matchesCategories = true;
      if (this.selectedCategories.length > 0) {
        matchesCategories = r.categories && r.categories.some(cat =>
          this.selectedCategories.includes(cat.id)
        );
      }

      // Filtre par tags (si des tags sont sÃ©lectionnÃ©s)
      let matchesTags = true;
      if (this.selectedTags.length > 0) {
        matchesTags = r.tags && r.tags.some(tag =>
          this.selectedTags.includes(tag.id)
        );
      }

      return matchesSearch && matchesEventType && matchesCategories && matchesTags;
    });

    return filtered.sort((a, b) => {
      let aVal = a[this.sortBy] || '';
      let bVal = b[this.sortBy] || '';
      if (this.sortBy === 'servings') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      if (this.sortOrder === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
  },

  toggleCategory(categoryId) {
    const index = this.selectedCategories.indexOf(categoryId);
    if (index > -1) {
      this.selectedCategories.splice(index, 1);
    } else {
      this.selectedCategories.push(categoryId);
    }
  },

  toggleTag(tagId) {
    const index = this.selectedTags.indexOf(tagId);
    if (index > -1) {
      this.selectedTags.splice(index, 1);
    } else {
      this.selectedTags.push(tagId);
    }
  },

  clearFilters() {
    this.selectedCategories = [];
    this.selectedTags = [];
    this.selectedEventTypeId = null;
  },

  getCategoryName(catId) {
    const cat = this.categories.find(c => c.id === catId);
    return cat ? (this.lang === 'jp' ? cat.name_jp : cat.name_fr) : '';
  },

  getTagName(tagId) {
    const tag = this.tags.find(t => t.id === tagId);
    return tag ? (this.lang === 'jp' ? tag.name_jp : tag.name_fr) : '';
  },

  getTagColor(tagId) {
    const tag = this.tags.find(t => t.id === tagId);
    return tag ? tag.color : '#3B82F6';
  },

  getEventTypeName(eventTypeId) {
    const et = this.eventTypes.find(e => e.id === eventTypeId);
    return et ? (this.lang === 'jp' ? et.name_jp : et.name_fr) : '';
  },

  sort(column) {
    if (this.sortBy === column) {
      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortBy = column;
      this.sortOrder = 'asc';
    }
  },

  confirmDelete(recipe) {
    this.recipeToDelete = recipe;
    this.deleteModal = true;
  },

  async deleteRecipe() {
    if (!this.recipeToDelete) return;

    try {
      const response = await fetch(`/api/recipe/${this.recipeToDelete.slug}?lang={{ lang }}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        // Supprimer de la liste locale
        this.recipes = this.recipes.filter(r => r.id !== this.recipeToDelete.id);
        this.deleteModal = false;
        this.recipeToDelete = null;
      } else {
        alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
    }
  },

  cancelDelete() {
    this.deleteModal = false;
    this.recipeToDelete = null;
  }
}">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">{{ S('all') }}</h1>
    <a href="/import?lang={{ lang }}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      {{ S('import') }}
    </a>
  </div>

  <!-- Barre de recherche -->
  <div class="mb-4">
    <input
      type="text"
      x-model="search"
      placeholder="ğŸ” {{ 'Rechercher une recette...' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢...' }}"
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    >
  </div>

  <!-- Filtres rapides par type d'Ã©vÃ©nement -->
  <div class="mb-4 flex gap-2 flex-wrap">
    <button
      @click="selectedEventTypeId = null"
      :class="selectedEventTypeId === null ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
      class="px-4 py-2 rounded-lg font-medium transition-colors">
      {{ 'Toutes' if lang == 'fr' else 'ã™ã¹ã¦' }}
    </button>
    <template x-for="eventType in eventTypes" :key="eventType.id">
      <button
        @click="selectedEventTypeId = eventType.id"
        :class="selectedEventTypeId === eventType.id ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'"
        class="px-4 py-2 rounded-lg font-medium transition-colors"
        x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr">
      </button>
    </template>
  </div>

  <!-- Filtres avancÃ©s (accordÃ©on) -->
  <div class="mb-4 bg-white border rounded-lg">
    <!-- Filtres actifs -->
    <div x-show="selectedEventTypeId !== null || selectedCategories.length > 0 || selectedTags.length > 0" class="p-3 border-b bg-blue-50">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-sm font-medium text-gray-700">{{ 'Filtres actifs :' if lang == 'fr' else 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:' }}</span>
        <!-- Type d'Ã©vÃ©nement actif -->
        <span x-show="selectedEventTypeId !== null" class="inline-flex items-center gap-1 px-2 py-1 bg-purple-600 text-white text-xs rounded">
          <span x-text="getEventTypeName(selectedEventTypeId)"></span>
          <button @click="selectedEventTypeId = null" class="hover:bg-purple-700 rounded">âœ•</button>
        </span>
        <!-- CatÃ©gories actives -->
        <template x-for="catId in selectedCategories" :key="catId">
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-600 text-white text-xs rounded">
            <span x-text="getCategoryName(catId)"></span>
            <button @click="toggleCategory(catId)" class="hover:bg-blue-700 rounded">âœ•</button>
          </span>
        </template>
        <!-- Tags actifs -->
        <template x-for="tagId in selectedTags" :key="tagId">
          <span class="inline-flex items-center gap-1 px-2 py-1 text-white text-xs rounded"
                :style="`background-color: ${getTagColor(tagId)}`">
            <span x-text="getTagName(tagId)"></span>
            <button @click="toggleTag(tagId)" class="hover:opacity-80 rounded">âœ•</button>
          </span>
        </template>
        <button @click="clearFilters()" class="text-xs text-red-600 hover:text-red-800 ml-2">
          {{ 'Effacer tout' if lang == 'fr' else 'ã™ã¹ã¦ã‚¯ãƒªã‚¢' }}
        </button>
      </div>
    </div>

    <!-- AccordÃ©on CatÃ©gories -->
    <div class="border-b">
      <button @click="showCategories = !showCategories"
              class="w-full flex items-center justify-between p-3 hover:bg-gray-50 transition">
        <span class="font-medium">
          ğŸ“‚ {{ 'CatÃ©gories' if lang == 'fr' else 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' }}
          <span x-show="selectedCategories.length > 0" class="text-sm text-blue-600">
            (<span x-text="selectedCategories.length"></span>)
          </span>
        </span>
        <svg class="w-5 h-5 transition-transform" :class="showCategories && 'rotate-180'"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="showCategories" x-collapse class="p-3 bg-gray-50">
        <div class="flex flex-wrap gap-2">
          <template x-for="category in categories" :key="category.id">
            <button
              @click="toggleCategory(category.id)"
              :class="selectedCategories.includes(category.id) ? 'bg-blue-600 text-white ring-2 ring-blue-600' : 'bg-white text-gray-700 hover:bg-gray-100'"
              class="px-3 py-1.5 rounded-lg border text-sm transition-all">
              <span x-text="lang === 'jp' ? category.name_jp : category.name_fr"></span>
              <span class="ml-1 text-xs opacity-75">(<span x-text="category.recipe_count || 0"></span>)</span>
            </button>
          </template>
        </div>
      </div>
    </div>

    <!-- AccordÃ©on Tags -->
    <div class="border-b">
      <button @click="showTags = !showTags"
              class="w-full flex items-center justify-between p-3 hover:bg-gray-50 transition">
        <span class="font-medium">
          ğŸ·ï¸ {{ 'Tags' if lang == 'fr' else 'ã‚¿ã‚°' }}
          <span x-show="selectedTags.length > 0" class="text-sm text-purple-600">
            (<span x-text="selectedTags.length"></span>)
          </span>
        </span>
        <svg class="w-5 h-5 transition-transform" :class="showTags && 'rotate-180'"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="showTags" x-collapse class="p-3 bg-gray-50">
        <div class="flex flex-wrap gap-2">
          <template x-for="tag in tags" :key="tag.id">
            <button
              @click="toggleTag(tag.id)"
              :class="selectedTags.includes(tag.id) ? 'ring-2 ring-offset-1 opacity-100' : 'opacity-70 hover:opacity-90'"
              :style="`background-color: ${tag.color}; color: white`"
              class="px-3 py-1.5 rounded-lg text-sm transition-all">
              <span x-text="lang === 'jp' ? tag.name_jp : tag.name_fr"></span>
              <span class="ml-1 text-xs opacity-90">(<span x-text="tag.recipe_count || 0"></span>)</span>
            </button>
          </template>
        </div>
      </div>
    </div>

    <!-- RÃ©sultat du filtrage -->
    <div class="p-3 text-sm text-gray-600 bg-gray-50">
      <span x-text="filteredRecipes.length"></span>
      {{ 'recette(s) trouvÃ©e(s)' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' }}
    </div>
  </div>

  <!-- Grille de cartes de recettes -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    <template x-for="r in filteredRecipes" :key="r.id">
      <div class="bg-white rounded-lg border overflow-hidden hover:shadow-lg transition-shadow">
        <!-- Image -->
        <a :href="`/recipe/${r.slug}?lang={{ lang }}`" class="block relative pb-[75%] overflow-hidden bg-gray-100">
          <img
            :src="r.thumbnail_url || '/static/images/recipe-placeholder.jpg'"
            :alt="r.name"
            class="absolute inset-0 w-full h-full object-cover"
          >
        </a>

        <!-- Contenu -->
        <div class="p-4">
          <a :href="`/recipe/${r.slug}?lang={{ lang }}`" class="block">
            <h3 class="font-semibold text-lg mb-2 hover:text-blue-600 transition" x-text="r.name"></h3>
          </a>

          <div class="flex items-center justify-end text-sm text-gray-600 mb-3">
            <span x-show="r.servings">ğŸ‘¥ <span x-text="r.servings"></span></span>
          </div>

          <!-- Event type badges -->
          <div x-show="r.event_types && r.event_types.length > 0" class="flex flex-wrap gap-1 mb-3">
            <template x-for="eventType in r.event_types" :key="eventType.id">
              <span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full"
                    x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr"></span>
            </template>
          </div>

          <!-- Actions -->
          <button
            @click="confirmDelete(r)"
            class="w-full text-red-600 hover:text-red-800 hover:bg-red-50 py-2 rounded transition text-sm"
          >
            ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
          </button>
        </div>
      </div>
    </template>

    <!-- Message si aucun rÃ©sultat -->
    <div x-show="filteredRecipes.length === 0" class="col-span-full p-12 text-center text-gray-500">
      <div class="text-6xl mb-4">ğŸ”</div>
      <div class="text-xl">{{ 'Aucune recette trouvÃ©e' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }}</div>
    </div>
  </div>

  {% if not rows %}
  <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm">
    {{ 'Aucune recette trouvÃ©e.' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }}
    <a href="/import?lang={{ lang }}" class="text-blue-700 underline">
      {{ 'Importez-en une !' if lang == 'fr' else 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼' }}
    </a>
  </div>
  {% endif %}

  <!-- Modal de confirmation de suppression -->
  <div
    x-show="deleteModal"
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="cancelDelete()"
  >
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
      <h2 class="text-xl font-bold mb-4">
        {{ 'Confirmer la suppression' if lang == 'fr' else 'å‰Šé™¤ã®ç¢ºèª' }}
      </h2>
      <p class="mb-6 text-gray-700">
        {{ 'ÃŠtes-vous sÃ»r de vouloir supprimer cette recette ?' if lang == 'fr' else 'ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' }}
      </p>
      <p class="mb-6 font-semibold text-gray-900" x-text="recipeToDelete?.name"></p>
      <div class="flex gap-3 justify-end">
        <button
          @click="cancelDelete()"
          class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
        >
          {{ 'Non' if lang == 'fr' else 'ã„ã„ãˆ' }}
        </button>
        <button
          @click="deleteRecipe()"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
        >
          {{ 'Oui, supprimer' if lang == 'fr' else 'ã¯ã„ã€å‰Šé™¤' }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}