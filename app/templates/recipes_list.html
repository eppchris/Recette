{% extends 'base.html' %}

{% block breadcrumb %}{{ S('all') }}{% endblock %}

{% block content %}

<script>
  // DonnÃ©es des recettes pour Alpine
  window.recipesData = {{ rows | tojson | safe }};
</script>

<div x-data="{
  lang: '{{ lang }}',
  search: '',
  searchIngredients: '',
  searchingByIngredients: false,
  sortBy: 'name',
  sortOrder: 'asc',
  recipes: window.recipesData || [],
  allRecipes: window.recipesData || [],
  categories: [],
  tags: [],
  eventTypes: [],
  selectedCategories: [],
  selectedTags: [],
  selectedEventTypeId: null,
  showCategories: false,
  showTags: false,
  deleteModal: false,
  recipeToDelete: null,
  creatorId: {{ creator_id or 'null' }},
  viewMode: 'grid',

  init() {
    // Initialiser le mode d'affichage depuis localStorage
    this.viewMode = localStorage.getItem('recipesViewMode') || 'grid';
    // Initialiser les filtres depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    this.selectedCategories = urlParams.get('categories') ? urlParams.get('categories').split(',').map(id => parseInt(id)) : [];
    this.selectedTags = urlParams.get('tags') ? urlParams.get('tags').split(',').map(id => parseInt(id)) : [];
    this.selectedEventTypeId = urlParams.get('event_type') ? parseInt(urlParams.get('event_type')) : null;
    this.search = urlParams.get('search') || '';
    this.sortBy = urlParams.get('sort_by') || 'name';
    this.sortOrder = urlParams.get('sort_order') || 'asc';
    this.creatorId = urlParams.get('creator_id') ? parseInt(urlParams.get('creator_id')) : {{ creator_id or 'null' }};

    this.loadCategoriesTagsAndEventTypes();
  },

  async loadCategoriesTagsAndEventTypes() {
    try {
      const [categoriesRes, tagsRes, eventTypesRes] = await Promise.all([
        fetch('/api/categories'),
        fetch('/api/tags'),
        fetch('/api/event-types')
      ]);
      this.categories = await categoriesRes.json();
      this.tags = await tagsRes.json();
      this.eventTypes = await eventTypesRes.json();
    } catch (error) {
      console.error('Erreur chargement catÃ©gories/tags/event types:', error);
    }
  },

  updateURL() {
    const params = new URLSearchParams();
    if (this.selectedCategories.length > 0) {
      params.set('categories', this.selectedCategories.join(','));
    }
    if (this.selectedTags.length > 0) {
      params.set('tags', this.selectedTags.join(','));
    }
    if (this.selectedEventTypeId) {
      params.set('event_type', this.selectedEventTypeId);
    }
    if (this.search) {
      params.set('search', this.search);
    }
    if (this.creatorId) {
      params.set('creator_id', this.creatorId);
    }
    if (this.sortBy !== 'name') {
      params.set('sort_by', this.sortBy);
    }
    if (this.sortOrder !== 'asc') {
      params.set('sort_order', this.sortOrder);
    }
    params.set('lang', this.lang);

    const newURL = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, '', newURL);
  },

  async searchByIngredients() {
    if (!this.searchIngredients.trim()) {
      this.recipes = this.allRecipes;
      this.searchingByIngredients = false;
      return;
    }

    this.searchingByIngredients = true;
    try {
      const response = await fetch(`/api/recipes/search-by-ingredients?ingredients=${encodeURIComponent(this.searchIngredients)}&lang=${this.lang}`);
      const results = await response.json();
      this.recipes = results;
    } catch (error) {
      console.error('Erreur recherche par ingrÃ©dients:', error);
      alert('{{ 'Erreur lors de la recherche' if lang == 'fr' else 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼' }}');
    }
  },

  clearIngredientSearch() {
    this.searchIngredients = '';
    this.recipes = this.allRecipes;
    this.searchingByIngredients = false;
  },

  get filteredRecipes() {
    let filtered = this.recipes.filter(r => {
      // Filtre de recherche textuelle
      const matchesSearch = this.search === '' || r.name.toLowerCase().includes(this.search.toLowerCase());

      // Filtre par type d'Ã©vÃ©nement
      let matchesEventType = this.selectedEventTypeId === null;
      if (!matchesEventType && r.event_types) {
        matchesEventType = r.event_types.some(et => et.id === this.selectedEventTypeId);
      }

      // Filtre par catÃ©gories (si des catÃ©gories sont sÃ©lectionnÃ©es)
      let matchesCategories = true;
      if (this.selectedCategories.length > 0) {
        matchesCategories = r.categories && r.categories.some(cat =>
          this.selectedCategories.includes(cat.id)
        );
      }

      // Filtre par tags (si des tags sont sÃ©lectionnÃ©s)
      let matchesTags = true;
      if (this.selectedTags.length > 0) {
        matchesTags = r.tags && r.tags.some(tag =>
          this.selectedTags.includes(tag.id)
        );
      }

      return matchesSearch && matchesEventType && matchesCategories && matchesTags;
    });

    return filtered.sort((a, b) => {
      let aVal = a[this.sortBy] || '';
      let bVal = b[this.sortBy] || '';
      if (this.sortBy === 'servings') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      if (this.sortOrder === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
  },

  toggleCategory(categoryId) {
    const index = this.selectedCategories.indexOf(categoryId);
    if (index > -1) {
      this.selectedCategories.splice(index, 1);
    } else {
      this.selectedCategories.push(categoryId);
    }
    this.updateURL();
  },

  toggleTag(tagId) {
    const index = this.selectedTags.indexOf(tagId);
    if (index > -1) {
      this.selectedTags.splice(index, 1);
    } else {
      this.selectedTags.push(tagId);
    }
    this.updateURL();
  },

  clearFilters() {
    this.selectedCategories = [];
    this.selectedTags = [];
    this.selectedEventTypeId = null;
    this.updateURL();
  },

  getCategoryName(catId) {
    const cat = this.categories.find(c => c.id === catId);
    return cat ? (this.lang === 'jp' ? cat.name_jp : cat.name_fr) : '';
  },

  changeCreator(creatorId) {
    const params = new URLSearchParams();
    params.set('lang', this.lang);
    if (creatorId) {
      params.set('creator_id', creatorId);
    }
    if (this.selectedCategories.length > 0) {
      params.set('categories', this.selectedCategories.join(','));
    }
    if (this.selectedTags.length > 0) {
      params.set('tags', this.selectedTags.join(','));
    }
    if (this.selectedEventTypeId) {
      params.set('event_type', this.selectedEventTypeId);
    }
    if (this.search) {
      params.set('search', this.search);
    }
    if (this.sortBy !== 'name') {
      params.set('sort_by', this.sortBy);
    }
    if (this.sortOrder !== 'asc') {
      params.set('sort_order', this.sortOrder);
    }

    window.location.href = `/recipes?${params.toString()}`;
  },

  getRecipeURL(recipeSlug) {
    const params = new URLSearchParams();
    if (this.selectedCategories.length > 0) {
      params.set('categories', this.selectedCategories.join(','));
    }
    if (this.selectedTags.length > 0) {
      params.set('tags', this.selectedTags.join(','));
    }
    if (this.selectedEventTypeId) {
      params.set('event_type', this.selectedEventTypeId);
    }
    if (this.search) {
      params.set('search', this.search);
    }
    if (this.creatorId) {
      params.set('creator_id', this.creatorId);
    }
    if (this.sortBy !== 'name') {
      params.set('sort_by', this.sortBy);
    }
    if (this.sortOrder !== 'asc') {
      params.set('sort_order', this.sortOrder);
    }
    params.set('lang', this.lang);

    return `/recipe/${recipeSlug}?${params.toString()}`;
  },

  getTagColor(tagId) {
    const tag = this.tags.find(t => t.id === tagId);
    return tag ? tag.color : '#3B82F6';
  },

  getEventTypeName(eventTypeId) {
    const et = this.eventTypes.find(e => e.id === eventTypeId);
    return et ? (this.lang === 'jp' ? et.name_jp : et.name_fr) : '';
  },

  sort(column) {
    if (this.sortBy === column) {
      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortBy = column;
      this.sortOrder = 'asc';
    }
    this.updateURL();
  },

  confirmDelete(recipe) {
    this.recipeToDelete = recipe;
    this.deleteModal = true;
  },

  async deleteRecipe() {
    if (!this.recipeToDelete) return;

    try {
      const response = await fetch(`/api/recipe/${this.recipeToDelete.slug}?lang={{ lang }}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        // Supprimer de la liste locale
        this.recipes = this.recipes.filter(r => r.id !== this.recipeToDelete.id);
        this.deleteModal = false;
        this.recipeToDelete = null;
      } else {
        alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('{{ 'Erreur lors de la suppression' if lang == 'fr' else 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }}');
    }
  },

  cancelDelete() {
    this.deleteModal = false;
    this.recipeToDelete = null;
  },

  setViewMode(mode) {
    this.viewMode = mode;
    localStorage.setItem('recipesViewMode', mode);
  }
}">
  <!-- Bouton retour vers l'accueil -->
  <div class="mb-4">
    <a href="/?lang={{ lang }}"
       class="inline-flex items-center gap-2 px-3 py-2
              text-blue-600 dark:text-blue-400
              hover:bg-blue-50 dark:hover:bg-blue-900/20
              rounded-lg transition-colors duration-150">
      <span class="text-lg">â†</span>
      <span class="font-medium">{{ 'Accueil' if lang == 'fr' else 'ãƒ›ãƒ¼ãƒ ' }}</span>
    </a>
  </div>

  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
    <h1 class="text-2xl font-bold">{{ S('all') }}</h1>
    <div class="flex gap-2 items-center">
      <!-- Boutons de mode d'affichage -->
      <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
        <button
          @click="setViewMode('grid')"
          :class="viewMode === 'grid' ? 'bg-white dark:bg-gray-600 shadow' : 'text-gray-500'"
          class="px-3 py-1.5 rounded transition-all"
          title="{{ 'Affichage en grille' if lang == 'fr' else 'ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º' }}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
          </svg>
        </button>
        <button
          @click="setViewMode('list')"
          :class="viewMode === 'list' ? 'bg-white dark:bg-gray-600 shadow' : 'text-gray-500'"
          class="px-3 py-1.5 rounded transition-all"
          title="{{ 'Affichage en liste' if lang == 'fr' else 'ãƒªã‚¹ãƒˆè¡¨ç¤º' }}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>

      <!-- Menu import -->
      <div class="relative w-full sm:w-auto" x-data="{ showImportMenu: false }">
        <button
          @click="showImportMenu = !showImportMenu"
          class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
          {{ S('import') }}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div
          x-show="showImportMenu"
          @click.away="showImportMenu = false"
          x-transition
          class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-10">
          <a href="/import?lang={{ lang }}" class="block px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg">
            <div class="font-semibold">ğŸ“„ {{ 'Import CSV' if lang == 'fr' else 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ' }}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{{ 'Fichier CSV local' if lang == 'fr' else 'ãƒ­ãƒ¼ã‚«ãƒ«CSVãƒ•ã‚¡ã‚¤ãƒ«' }}</div>
          </a>
          <a href="/import-url?lang={{ lang }}" class="block px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700">
            <div class="font-semibold">ğŸŒ {{ 'Import depuis URL' if lang == 'fr' else 'URLã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ' }}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{{ 'Importer depuis un site web' if lang == 'fr' else 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ' }}</div>
          </a>
          <a href="/import-pdf?lang={{ lang }}" class="block px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-lg">
            <div class="font-semibold">ğŸ“‘ {{ 'Import PDF' if lang == 'fr' else 'PDFã‚¤ãƒ³ãƒãƒ¼ãƒˆ' }}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{{ 'Document PDF' if lang == 'fr' else 'PDFãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ' }}</div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Barre de recherche et filtre crÃ©ateur -->
  <div class="mb-4 flex flex-col sm:flex-row gap-3">
    <input
      type="text"
      x-model="search"
      @input="updateURL()"
      placeholder="ğŸ” {{ 'Rechercher une recette...' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢...' }}"
      class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
    >

    <!-- Filtre par crÃ©ateur -->
    <select
      @change="changeCreator($event.target.value)"
      class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white"
    >
      <option value="">{{ 'Tous les crÃ©ateurs' if lang == 'fr' else 'ã™ã¹ã¦ã®ä½œæˆè€…' }}</option>
      {% for user in users %}
      <option value="{{ user.id }}" {% if creator_id == user.id %}selected{% endif %}>
        {{ user.display_name or user.username }}
      </option>
      {% endfor %}
    </select>
  </div>

  <!-- Recherche par ingrÃ©dients -->
  <div class="mb-4 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 border-2 border-green-200 dark:border-green-700 rounded-lg p-4">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-lg">ğŸ¥•</span>
      <h3 class="font-semibold text-gray-900 dark:text-white">
        {{ 'Recherche par ingrÃ©dients' if lang == 'fr' else 'é£Ÿæã§æ¤œç´¢' }}
      </h3>
    </div>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
      {{ 'Entrez plusieurs ingrÃ©dients sÃ©parÃ©s par des virgules (ex: tomate, basilic, mozzarella)' if lang == 'fr' else 'è¤‡æ•°ã®é£Ÿæã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒˆãƒãƒˆã€ãƒã‚¸ãƒ«ã€ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ©ï¼‰' }}
    </p>
    <div class="flex flex-col sm:flex-row gap-2">
      <input
        type="text"
        x-model="searchIngredients"
        @keyup.enter="searchByIngredients()"
        placeholder="{{ 'tomate, basilic, mozzarella...' if lang == 'fr' else 'ãƒˆãƒãƒˆã€ãƒã‚¸ãƒ«ã€ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ©...' }}"
        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
      >
      <div class="flex gap-2">
        <button
          @click="searchByIngredients()"
          class="flex-1 sm:flex-none px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
          {{ 'Rechercher' if lang == 'fr' else 'æ¤œç´¢' }}
        </button>
        <button
          x-show="searchingByIngredients"
          @click="clearIngredientSearch()"
          class="flex-1 sm:flex-none px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors">
          {{ 'Effacer' if lang == 'fr' else 'ã‚¯ãƒªã‚¢' }}
        </button>
      </div>
    </div>
    <div x-show="searchingByIngredients" class="mt-2 text-sm text-green-700 dark:text-green-400">
      âœ“ {{ 'Recherche active avec' if lang == 'fr' else 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ¤œç´¢:' }} "<span x-text="searchIngredients"></span>"
    </div>
  </div>

  <!-- Filtres rapides par type d'Ã©vÃ©nement -->
  <div class="mb-4 flex gap-2 flex-wrap">
    <button
      @click="selectedEventTypeId = null; updateURL()"
      :class="selectedEventTypeId === null ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
      class="px-4 py-2 rounded-lg font-medium transition-colors">
      {{ 'Toutes' if lang == 'fr' else 'ã™ã¹ã¦' }}
    </button>
    <template x-for="eventType in eventTypes" :key="eventType.id">
      <button
        @click="selectedEventTypeId = eventType.id; updateURL()"
        :class="selectedEventTypeId === eventType.id ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'"
        class="px-4 py-2 rounded-lg font-medium transition-colors"
        x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr">
      </button>
    </template>
  </div>

  <!-- Filtres avancÃ©s (accordÃ©on) -->
  <div class="mb-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
    <!-- Filtres actifs -->
    <div x-show="selectedEventTypeId !== null || selectedCategories.length > 0 || selectedTags.length > 0" class="p-3 border-b border-gray-200 dark:border-gray-700 bg-blue-50 dark:bg-blue-900/20">
      <div class="flex items-center gap-2 flex-wrap text-sm sm:text-base">
        <span class="text-sm font-medium text-gray-700">{{ 'Filtres actifs :' if lang == 'fr' else 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:' }}</span>
        <!-- Type d'Ã©vÃ©nement actif -->
        <span x-show="selectedEventTypeId !== null" class="inline-flex items-center gap-1 px-2 py-1 bg-purple-600 text-white text-xs rounded">
          <span x-text="getEventTypeName(selectedEventTypeId)"></span>
          <button @click="selectedEventTypeId = null" class="hover:bg-purple-700 rounded">âœ•</button>
        </span>
        <!-- CatÃ©gories actives -->
        <template x-for="catId in selectedCategories" :key="catId">
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-600 text-white text-xs rounded">
            <span x-text="getCategoryName(catId)"></span>
            <button @click="toggleCategory(catId)" class="hover:bg-blue-700 rounded">âœ•</button>
          </span>
        </template>
        <!-- Tags actifs -->
        <template x-for="tagId in selectedTags" :key="tagId">
          <span class="inline-flex items-center gap-1 px-2 py-1 text-white text-xs rounded"
                :style="`background-color: ${getTagColor(tagId)}`">
            <span x-text="getTagName(tagId)"></span>
            <button @click="toggleTag(tagId)" class="hover:opacity-80 rounded">âœ•</button>
          </span>
        </template>
        <button @click="clearFilters()" class="text-xs text-red-600 hover:text-red-800 ml-2">
          {{ 'Effacer tout' if lang == 'fr' else 'ã™ã¹ã¦ã‚¯ãƒªã‚¢' }}
        </button>
      </div>
    </div>

    <!-- AccordÃ©on CatÃ©gories -->
    <div class="border-b border-gray-200 dark:border-gray-700">
      <button @click="showCategories = !showCategories"
              class="w-full flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
        <span class="font-medium text-sm sm:text-base">
          ğŸ“‚ {{ 'CatÃ©gories' if lang == 'fr' else 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' }}
          <span x-show="selectedCategories.length > 0" class="text-sm text-blue-600 dark:text-blue-400">
            (<span x-text="selectedCategories.length"></span>)
          </span>
        </span>
        <svg class="w-5 h-5 transition-transform" :class="showCategories && 'rotate-180'"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="showCategories" x-collapse class="p-3 bg-gray-50 dark:bg-gray-900/50">
        <div class="flex flex-wrap gap-2">
          <template x-for="category in categories" :key="category.id">
            <button
              @click="toggleCategory(category.id)"
              :class="selectedCategories.includes(category.id) ? 'bg-blue-600 text-white ring-2 ring-blue-600' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600'"
              class="px-2 sm:px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-xs sm:text-sm transition-all">
              <span x-text="lang === 'jp' ? category.name_jp : category.name_fr"></span>
              <span class="ml-1 text-xs opacity-75">(<span x-text="category.recipe_count || 0"></span>)</span>
            </button>
          </template>
        </div>
      </div>
    </div>

    <!-- AccordÃ©on Tags -->
    <div class="border-b border-gray-200 dark:border-gray-700">
      <button @click="showTags = !showTags"
              class="w-full flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
        <span class="font-medium text-sm sm:text-base">
          ğŸ·ï¸ {{ 'Tags' if lang == 'fr' else 'ã‚¿ã‚°' }}
          <span x-show="selectedTags.length > 0" class="text-sm text-purple-600 dark:text-purple-400">
            (<span x-text="selectedTags.length"></span>)
          </span>
        </span>
        <svg class="w-5 h-5 transition-transform" :class="showTags && 'rotate-180'"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="showTags" x-collapse class="p-3 bg-gray-50 dark:bg-gray-900/50">
        <div class="flex flex-wrap gap-2">
          <template x-for="tag in tags" :key="tag.id">
            <button
              @click="toggleTag(tag.id)"
              :class="selectedTags.includes(tag.id) ? 'ring-2 ring-offset-1 opacity-100' : 'opacity-70 hover:opacity-90'"
              :style="`background-color: ${tag.color}; color: white`"
              class="px-2 sm:px-3 py-1.5 rounded-lg text-xs sm:text-sm transition-all">
              <span x-text="lang === 'jp' ? tag.name_jp : tag.name_fr"></span>
              <span class="ml-1 text-xs opacity-90">(<span x-text="tag.recipe_count || 0"></span>)</span>
            </button>
          </template>
        </div>
      </div>
    </div>

    <!-- RÃ©sultat du filtrage -->
    <div class="p-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/50">
      <span x-text="filteredRecipes.length"></span>
      {{ 'recette(s) trouvÃ©e(s)' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' }}
    </div>
  </div>

  <!-- Affichage en grille -->
  <div x-show="viewMode === 'grid'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
    <template x-for="r in filteredRecipes" :key="r.id">
      <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-shadow">
        <!-- Image -->
        <a :href="getRecipeURL(r.slug)" class="block relative pb-[75%] overflow-hidden bg-gray-100">
          <img
            :src="r.thumbnail_url || '/static/images/recipe-placeholder.jpg'"
            :alt="r.name"
            class="absolute inset-0 w-full h-full object-cover"
          >
        </a>

        <!-- Contenu -->
        <div class="p-4">
          <a :href="getRecipeURL(r.slug)" class="block">
            <h3 class="font-semibold text-lg mb-2 hover:text-blue-600 transition" x-text="r.name"></h3>
          </a>

          <!-- CrÃ©ateur -->
          <div x-show="r.creator_name" class="flex items-center text-xs text-gray-500 mb-2">
            <span class="mr-1">ğŸ‘¤</span>
            <span x-text="r.creator_name"></span>
          </div>

          <!-- Type de recette / Prestation -->
          <div x-show="r.type" class="flex items-center text-xs text-gray-500 mb-2">
            <span class="mr-1">ğŸ“‹</span>
            <span x-text="r.type"></span>
          </div>

          <div class="flex items-center justify-end text-sm text-gray-600 mb-3">
            <span x-show="r.servings">ğŸ‘¥ <span x-text="r.servings"></span></span>
          </div>

          <!-- Event type badges -->
          <div x-show="r.event_types && r.event_types.length > 0" class="flex flex-wrap gap-1 mb-3">
            <template x-for="eventType in r.event_types" :key="eventType.id">
              <span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full"
                    x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr"></span>
            </template>
          </div>

          <!-- Actions -->
          <button
            @click="confirmDelete(r)"
            class="w-full text-red-600 hover:text-red-800 hover:bg-red-50 py-2 rounded transition text-sm"
          >
            ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
          </button>
        </div>
      </div>
    </template>

    <!-- Message si aucun rÃ©sultat -->
    <div x-show="filteredRecipes.length === 0" class="col-span-full p-12 text-center text-gray-500">
      <div class="text-6xl mb-4">ğŸ”</div>
      <div class="text-xl">{{ 'Aucune recette trouvÃ©e' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }}</div>
    </div>
  </div>

  <!-- Affichage en liste -->
  <div x-show="viewMode === 'list'" class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
    <table class="w-full">
      <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
            <button @click="sort('name')" class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-100">
              {{ 'Nom' if lang == 'fr' else 'åå‰' }}
              <span x-show="sortBy === 'name'">
                <svg x-show="sortOrder === 'asc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <svg x-show="sortOrder === 'desc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/>
                </svg>
              </span>
            </button>
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden sm:table-cell">
            <button @click="sort('type')" class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-100">
              {{ 'Type' if lang == 'fr' else 'ã‚¿ã‚¤ãƒ—' }}
              <span x-show="sortBy === 'type'">
                <svg x-show="sortOrder === 'asc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <svg x-show="sortOrder === 'desc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/>
                </svg>
              </span>
            </button>
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell">
            <button @click="sort('creator_name')" class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-100">
              {{ 'CrÃ©ateur' if lang == 'fr' else 'ä½œæˆè€…' }}
              <span x-show="sortBy === 'creator_name'">
                <svg x-show="sortOrder === 'asc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <svg x-show="sortOrder === 'desc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/>
                </svg>
              </span>
            </button>
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden lg:table-cell">
            <button @click="sort('servings')" class="flex items-center gap-1 hover:text-gray-700 dark:hover:text-gray-100 mx-auto">
              {{ 'Personnes' if lang == 'fr' else 'äººæ•°' }}
              <span x-show="sortBy === 'servings'">
                <svg x-show="sortOrder === 'asc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <svg x-show="sortOrder === 'desc'" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/>
                </svg>
              </span>
            </button>
          </th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
            {{ 'Actions' if lang == 'fr' else 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³' }}
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
        <template x-for="r in filteredRecipes" :key="r.id">
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-4 py-3">
              <a :href="getRecipeURL(r.slug)" class="flex items-center gap-3 group">
                <img
                  :src="r.thumbnail_url || '/static/images/recipe-placeholder.jpg'"
                  :alt="r.name"
                  class="w-12 h-12 object-cover rounded"
                >
                <span class="font-medium text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400" x-text="r.name"></span>
              </a>
            </td>
            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 hidden sm:table-cell">
              <span x-text="r.type || '-'"></span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 hidden md:table-cell">
              <span x-text="r.creator_name || '-'"></span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-center hidden lg:table-cell">
              <span x-show="r.servings">ğŸ‘¥ <span x-text="r.servings"></span></span>
              <span x-show="!r.servings">-</span>
            </td>
            <td class="px-4 py-3 text-right">
              <button
                @click="confirmDelete(r)"
                class="text-red-600 hover:text-red-800 dark:hover:text-red-400 transition text-sm"
              >
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <!-- Message si aucun rÃ©sultat -->
    <div x-show="filteredRecipes.length === 0" class="p-12 text-center text-gray-500">
      <div class="text-6xl mb-4">ğŸ”</div>
      <div class="text-xl">{{ 'Aucune recette trouvÃ©e' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }}</div>
    </div>
  </div>

  {% if not rows %}
  <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm">
    {{ 'Aucune recette trouvÃ©e.' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' }}
    <a href="/import?lang={{ lang }}" class="text-blue-700 underline">
      {{ 'Importez-en une !' if lang == 'fr' else 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼' }}
    </a>
  </div>
  {% endif %}

  <!-- Modal de confirmation de suppression -->
  <div
    x-show="deleteModal"
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    @click.self="cancelDelete()"
  >
    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 sm:p-6 max-w-md w-full shadow-xl">
      <h2 class="text-xl font-bold mb-4">
        {{ 'Confirmer la suppression' if lang == 'fr' else 'å‰Šé™¤ã®ç¢ºèª' }}
      </h2>
      <p class="mb-4 sm:mb-6 text-gray-700 dark:text-gray-300">
        {{ 'ÃŠtes-vous sÃ»r de vouloir supprimer cette recette ?' if lang == 'fr' else 'ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' }}
      </p>
      <p class="mb-4 sm:mb-6 font-semibold text-gray-900 dark:text-white" x-text="recipeToDelete?.name"></p>
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 sm:justify-end">
        <button
          @click="cancelDelete()"
          class="w-full sm:w-auto px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition"
        >
          {{ 'Non' if lang == 'fr' else 'ã„ã„ãˆ' }}
        </button>
        <button
          @click="deleteRecipe()"
          class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
        >
          {{ 'Oui, supprimer' if lang == 'fr' else 'ã¯ã„ã€å‰Šé™¤' }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}