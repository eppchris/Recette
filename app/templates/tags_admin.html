{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto p-6" x-data="tagsAdmin()">
  <!-- En-tÃªte -->
  <header class="mb-8">
    <h1 class="text-3xl font-bold mb-2">
      {{ 'ã‚¿ã‚°ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç®¡ç†' if lang == 'jp' else 'Gestion des Tags et CatÃ©gories' }}
    </h1>
    <p class="text-gray-600">
      {{ 'ã‚¿ã‚°ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä½œæˆã€ç·¨é›†ã€å‰Šé™¤ã—ã¾ã™' if lang == 'jp' else 'CrÃ©er, modifier et supprimer des tags et catÃ©gories' }}
    </p>
  </header>

  <!-- Messages -->
  <div x-show="message" x-transition
       :class="messageType === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'"
       class="border px-4 py-3 rounded mb-6">
    <span x-text="message"></span>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- ============== CATÃ‰GORIES ============== -->
    <section class="bg-white border rounded-lg p-6">
      <h2 class="text-2xl font-bold mb-4 text-blue-600">
        {{ 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' if lang == 'jp' else 'CatÃ©gories' }}
      </h2>

      <!-- Formulaire d'ajout -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <h3 class="font-semibold mb-3">{{ 'Nouvelle catÃ©gorie' if lang == 'fr' else 'æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼' }}</h3>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newCategory.name_fr"
              placeholder="Nom FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newCategory.name_jp"
              placeholder="åå‰ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newCategory.description_fr"
              placeholder="Description FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newCategory.description_jp"
              placeholder="èª¬æ˜ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <button
            @click="createCategory()"
            :disabled="!newCategory.name_fr || !newCategory.name_jp || creatingCategory"
            class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!creatingCategory">{{ '+ CrÃ©er la catÃ©gorie' if lang == 'fr' else '+ ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä½œæˆ' }}</span>
            <span x-show="creatingCategory">{{ 'CrÃ©ation...' if lang == 'fr' else 'ä½œæˆä¸­...' }}</span>
          </button>
        </div>
      </div>

      <!-- Liste des catÃ©gories -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        <template x-for="category in categories" :key="category.id">
          <div>
            <!-- Mode affichage -->
            <div
              x-show="editingCategoryId !== category.id"
              class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100"
            >
              <div class="flex-1">
                <div class="font-medium" x-text="lang === 'jp' ? category.name_jp : category.name_fr"></div>
                <div class="text-xs text-gray-500" x-text="lang === 'jp' ? category.description_jp : category.description_fr"></div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 bg-blue-100 rounded">
                  <span x-text="category.recipe_count || 0"></span> {{ 'recettes' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”' }}
                </span>
                <button
                  @click="startEditCategory(category)"
                  class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm"
                >
                  âœï¸ {{ 'Modifier' if lang == 'fr' else 'ç·¨é›†' }}
                </button>
                <button
                  @click="deleteCategory(category.id, category.name_fr)"
                  class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm"
                >
                  ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
                </button>
              </div>
            </div>

            <!-- Mode Ã©dition -->
            <div
              x-show="editingCategoryId === category.id"
              class="p-3 bg-blue-50 border-2 border-blue-300 rounded"
            >
              <div class="space-y-2">
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingCategory.name_fr"
                    placeholder="Nom FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingCategory.name_jp"
                    placeholder="åå‰ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingCategory.description_fr"
                    placeholder="Description FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingCategory.description_jp"
                    placeholder="èª¬æ˜ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="flex gap-2 mt-3">
                  <button
                    @click="updateCategory()"
                    class="flex-1 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                  >
                    {{ 'Enregistrer' if lang == 'fr' else 'ä¿å­˜' }}
                  </button>
                  <button
                    @click="cancelEditCategory()"
                    class="flex-1 px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm"
                  >
                    {{ 'Annuler' if lang == 'fr' else 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </section>

    <!-- ============== TAGS ============== -->
    <section class="bg-white border rounded-lg p-6">
      <h2 class="text-2xl font-bold mb-4 text-purple-600">
        {{ 'ã‚¿ã‚°' if lang == 'jp' else 'Tags' }}
      </h2>

      <!-- Formulaire d'ajout -->
      <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
        <h3 class="font-semibold mb-3">{{ 'Nouveau tag' if lang == 'fr' else 'æ–°ã—ã„ã‚¿ã‚°' }}</h3>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newTag.name_fr"
              placeholder="Nom FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newTag.name_jp"
              placeholder="åå‰ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newTag.description_fr"
              placeholder="Description FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newTag.description_jp"
              placeholder="èª¬æ˜ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium">{{ 'Couleur' if lang == 'fr' else 'è‰²' }}:</label>
            <input
              type="color"
              x-model="newTag.color"
              class="w-16 h-10 border rounded cursor-pointer"
            />
            <span class="text-sm text-gray-600" x-text="newTag.color"></span>
          </div>
          <button
            @click="createTag()"
            :disabled="!newTag.name_fr || !newTag.name_jp || creating"
            class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!creating">{{ '+ CrÃ©er le tag' if lang == 'fr' else '+ ã‚¿ã‚°ã‚’ä½œæˆ' }}</span>
            <span x-show="creating">{{ 'CrÃ©ation...' if lang == 'fr' else 'ä½œæˆä¸­...' }}</span>
          </button>
        </div>
      </div>

      <!-- Liste des tags -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        <template x-for="tag in tags" :key="tag.id">
          <div>
            <!-- Mode affichage -->
            <div
              x-show="editingTagId !== tag.id"
              class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100"
            >
              <div class="flex items-center gap-3 flex-1">
                <span
                  class="w-4 h-4 rounded-full border"
                  :style="`background-color: ${tag.color}`"
                ></span>
                <div class="flex-1">
                  <div class="font-medium" x-text="lang === 'jp' ? tag.name_jp : tag.name_fr"></div>
                  <div class="text-xs text-gray-500" x-text="lang === 'jp' ? tag.description_jp : tag.description_fr"></div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 bg-gray-200 rounded">
                  <span x-text="tag.recipe_count || 0"></span> {{ 'recettes' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”' }}
                </span>
                <span
                  x-show="tag.is_system"
                  class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded"
                >{{ 'SystÃ¨me' if lang == 'fr' else 'ã‚·ã‚¹ãƒ†ãƒ ' }}</span>
                <button
                  x-show="!tag.is_system"
                  @click="startEditTag(tag)"
                  class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm"
                >
                  âœï¸ {{ 'Modifier' if lang == 'fr' else 'ç·¨é›†' }}
                </button>
                <button
                  x-show="!tag.is_system"
                  @click="deleteTag(tag.id, tag.name_fr)"
                  class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm"
                >
                  ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
                </button>
              </div>
            </div>

            <!-- Mode Ã©dition -->
            <div
              x-show="editingTagId === tag.id"
              class="p-3 bg-purple-50 border-2 border-purple-300 rounded"
            >
              <div class="space-y-2">
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingTag.name_fr"
                    placeholder="Nom FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingTag.name_jp"
                    placeholder="åå‰ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingTag.description_fr"
                    placeholder="Description FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingTag.description_jp"
                    placeholder="èª¬æ˜ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm font-medium">{{ 'Couleur' if lang == 'fr' else 'è‰²' }}:</label>
                  <input
                    type="color"
                    x-model="editingTag.color"
                    class="w-12 h-8 border rounded cursor-pointer"
                  />
                  <span class="text-sm text-gray-600" x-text="editingTag.color"></span>
                </div>
                <div class="flex gap-2 mt-3">
                  <button
                    @click="updateTag()"
                    class="flex-1 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                  >
                    {{ 'Enregistrer' if lang == 'fr' else 'ä¿å­˜' }}
                  </button>
                  <button
                    @click="cancelEditTag()"
                    class="flex-1 px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm"
                  >
                    {{ 'Annuler' if lang == 'fr' else 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </section>

    <!-- ============== TYPES D'Ã‰VÃ‰NEMENTS ============== -->
    <section class="bg-white border rounded-lg p-6">
      <h2 class="text-2xl font-bold mb-4 text-green-600">
        {{ 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—' if lang == 'jp' else 'Types d\'Ã©vÃ©nements' }}
      </h2>

      <!-- Formulaire d'ajout -->
      <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
        <h3 class="font-semibold mb-3">{{ 'Nouveau type' if lang == 'fr' else 'æ–°ã—ã„ã‚¿ã‚¤ãƒ—' }}</h3>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newEventType.name_fr"
              placeholder="Nom FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newEventType.name_jp"
              placeholder="åå‰ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              x-model="newEventType.description_fr"
              placeholder="Description FR"
              class="px-3 py-2 border rounded text-sm"
            />
            <input
              type="text"
              x-model="newEventType.description_jp"
              placeholder="èª¬æ˜ JP"
              class="px-3 py-2 border rounded text-sm"
            />
          </div>
          <button
            @click="createEventType()"
            :disabled="!newEventType.name_fr || !newEventType.name_jp || creatingEventType"
            class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!creatingEventType">{{ '+ CrÃ©er le type' if lang == 'fr' else '+ ã‚¿ã‚¤ãƒ—ã‚’ä½œæˆ' }}</span>
            <span x-show="creatingEventType">{{ 'CrÃ©ation...' if lang == 'fr' else 'ä½œæˆä¸­...' }}</span>
          </button>
        </div>
      </div>

      <!-- Liste des types d'Ã©vÃ©nements -->
      <div class="space-y-2 max-h-96 overflow-y-auto">
        <template x-for="eventType in eventTypes" :key="eventType.id">
          <div>
            <!-- Mode affichage -->
            <div
              x-show="editingEventTypeId !== eventType.id"
              class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100"
            >
              <div class="flex-1">
                <div class="font-medium" x-text="lang === 'jp' ? eventType.name_jp : eventType.name_fr"></div>
                <div class="text-xs text-gray-500" x-text="lang === 'jp' ? eventType.description_jp : eventType.description_fr"></div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 bg-green-100 rounded">
                  <span x-text="eventType.event_count || 0"></span> {{ 'Ã©vÃ©nements' if lang == 'fr' else 'ã‚¤ãƒ™ãƒ³ãƒˆ' }}
                </span>
                <button
                  @click="startEditEventType(eventType)"
                  class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm"
                >
                  âœï¸ {{ 'Modifier' if lang == 'fr' else 'ç·¨é›†' }}
                </button>
                <button
                  @click="deleteEventType(eventType.id, eventType.name_fr)"
                  class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm"
                >
                  ğŸ—‘ï¸ {{ 'Supprimer' if lang == 'fr' else 'å‰Šé™¤' }}
                </button>
              </div>
            </div>

            <!-- Mode Ã©dition -->
            <div
              x-show="editingEventTypeId === eventType.id"
              class="p-3 bg-green-50 border-2 border-green-300 rounded"
            >
              <div class="space-y-2">
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingEventType.name_fr"
                    placeholder="Nom FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingEventType.name_jp"
                    placeholder="åå‰ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    x-model="editingEventType.description_fr"
                    placeholder="Description FR"
                    class="px-2 py-1 border rounded text-sm"
                  />
                  <input
                    type="text"
                    x-model="editingEventType.description_jp"
                    placeholder="èª¬æ˜ JP"
                    class="px-2 py-1 border rounded text-sm"
                  />
                </div>
                <div class="flex gap-2 mt-3">
                  <button
                    @click="updateEventType()"
                    class="flex-1 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                  >
                    {{ 'Enregistrer' if lang == 'fr' else 'ä¿å­˜' }}
                  </button>
                  <button
                    @click="cancelEditEventType()"
                    class="flex-1 px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm"
                  >
                    {{ 'Annuler' if lang == 'fr' else 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </section>
  </div>

  <!-- Bouton retour -->
  <div class="mt-8 pt-4 border-t">
    <a href="/recipes?lang={{ lang }}" class="text-blue-600 hover:underline">
      â† {{ 'Retour aux recettes' if lang == 'fr' else 'ãƒ¬ã‚·ãƒ”ã«æˆ»ã‚‹' }}
    </a>
  </div>
</div>

<script>
function tagsAdmin() {
  return {
    lang: '{{ lang }}',
    categories: [],
    tags: [],
    eventTypes: [],
    newCategory: {
      name_fr: '',
      name_jp: '',
      description_fr: '',
      description_jp: ''
    },
    newTag: {
      name_fr: '',
      name_jp: '',
      description_fr: '',
      description_jp: '',
      color: '#3B82F6'
    },
    newEventType: {
      name_fr: '',
      name_jp: '',
      description_fr: '',
      description_jp: ''
    },
    creatingCategory: false,
    creating: false,
    creatingEventType: false,
    message: '',
    messageType: 'info',
    editingCategoryId: null,
    editingCategory: {},
    editingTagId: null,
    editingTag: {},
    editingEventTypeId: null,
    editingEventType: {},

    async init() {
      await this.loadData();
    },

    async loadData() {
      try {
        const [categoriesRes, tagsRes, eventTypesRes] = await Promise.all([
          fetch('/api/categories'),
          fetch('/api/tags'),
          fetch('/api/event-types')
        ]);

        this.categories = await categoriesRes.json();
        this.tags = await tagsRes.json();
        this.eventTypes = await eventTypesRes.json();

        console.log('âœ… DonnÃ©es chargÃ©es:', this.categories.length, 'catÃ©gories,', this.tags.length, 'tags,', this.eventTypes.length, 'types d\'Ã©vÃ©nements');
      } catch (error) {
        console.error('Erreur de chargement:', error);
        this.showMessage('Erreur de chargement des donnÃ©es', 'error');
      }
    },

    async createTag() {
      this.creating = true;
      this.message = '';

      try {
        const response = await fetch('/api/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.newTag)
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Tag crÃ©Ã© avec succÃ¨s' : 'ã‚¿ã‚°ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          // RÃ©initialiser le formulaire
          this.newTag = {
            name_fr: '',
            name_jp: '',
            description_fr: '',
            description_jp: '',
            color: '#3B82F6'
          };
          // Recharger la liste
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur crÃ©ation tag:', error);
        this.showMessage('Erreur lors de la crÃ©ation du tag', 'error');
      } finally {
        this.creating = false;
      }
    },

    async deleteTag(tagId, tagName) {
      if (!confirm(`${this.lang === 'fr' ? 'Supprimer le tag' : 'ã‚¿ã‚°ã‚’å‰Šé™¤'} "${tagName}" ?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/tags/${tagId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Tag supprimÃ©' : 'ã‚¿ã‚°ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur suppression tag:', error);
        this.showMessage('Erreur lors de la suppression', 'error');
      }
    },

    startEditTag(tag) {
      this.editingTagId = tag.id;
      this.editingTag = {
        id: tag.id,
        name_fr: tag.name_fr,
        name_jp: tag.name_jp,
        description_fr: tag.description_fr || '',
        description_jp: tag.description_jp || '',
        color: tag.color
      };
    },

    cancelEditTag() {
      this.editingTagId = null;
      this.editingTag = {};
    },

    async updateTag() {
      try {
        const response = await fetch(`/api/tags/${this.editingTag.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name_fr: this.editingTag.name_fr,
            name_jp: this.editingTag.name_jp,
            description_fr: this.editingTag.description_fr,
            description_jp: this.editingTag.description_jp,
            color: this.editingTag.color
          })
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Tag modifiÃ© avec succÃ¨s' : 'ã‚¿ã‚°ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          this.editingTagId = null;
          this.editingTag = {};
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur modification tag:', error);
        this.showMessage('Erreur lors de la modification du tag', 'error');
      }
    },

    showMessage(text, type) {
      this.message = text;
      this.messageType = type;
      setTimeout(() => {
        this.message = '';
      }, 5000);
    },

    // ========== Fonctions pour les catÃ©gories ==========

    async createCategory() {
      this.creatingCategory = true;
      this.message = '';

      try {
        const response = await fetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.newCategory)
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'CatÃ©gorie crÃ©Ã©e avec succÃ¨s' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          // RÃ©initialiser le formulaire
          this.newCategory = {
            name_fr: '',
            name_jp: '',
            description_fr: '',
            description_jp: ''
          };
          // Recharger la liste
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur crÃ©ation catÃ©gorie:', error);
        this.showMessage('Erreur lors de la crÃ©ation de la catÃ©gorie', 'error');
      } finally {
        this.creatingCategory = false;
      }
    },

    async deleteCategory(categoryId, categoryName) {
      if (!confirm(`${this.lang === 'fr' ? 'Supprimer la catÃ©gorie' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤'} "${categoryName}" ?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/categories/${categoryId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'CatÃ©gorie supprimÃ©e' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur suppression catÃ©gorie:', error);
        this.showMessage('Erreur lors de la suppression', 'error');
      }
    },

    startEditCategory(category) {
      this.editingCategoryId = category.id;
      this.editingCategory = {
        id: category.id,
        name_fr: category.name_fr,
        name_jp: category.name_jp,
        description_fr: category.description_fr || '',
        description_jp: category.description_jp || ''
      };
    },

    cancelEditCategory() {
      this.editingCategoryId = null;
      this.editingCategory = {};
    },

    async updateCategory() {
      try {
        const response = await fetch(`/api/categories/${this.editingCategory.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name_fr: this.editingCategory.name_fr,
            name_jp: this.editingCategory.name_jp,
            description_fr: this.editingCategory.description_fr,
            description_jp: this.editingCategory.description_jp
          })
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'CatÃ©gorie modifiÃ©e avec succÃ¨s' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          this.editingCategoryId = null;
          this.editingCategory = {};
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur modification catÃ©gorie:', error);
        this.showMessage('Erreur lors de la modification de la catÃ©gorie', 'error');
      }
    },

    // ========== Fonctions pour les types d'Ã©vÃ©nements ==========

    async createEventType() {
      this.creatingEventType = true;
      this.message = '';

      try {
        const response = await fetch('/api/event-types', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.newEventType)
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Type d\'Ã©vÃ©nement crÃ©Ã© avec succÃ¨s' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          // RÃ©initialiser le formulaire
          this.newEventType = {
            name_fr: '',
            name_jp: '',
            description_fr: '',
            description_jp: ''
          };
          // Recharger la liste
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur crÃ©ation type d\'Ã©vÃ©nement:', error);
        this.showMessage('Erreur lors de la crÃ©ation du type d\'Ã©vÃ©nement', 'error');
      } finally {
        this.creatingEventType = false;
      }
    },

    async deleteEventType(eventTypeId, eventTypeName) {
      if (!confirm(`${this.lang === 'fr' ? 'Supprimer le type d\'Ã©vÃ©nement' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’å‰Šé™¤'} "${eventTypeName}" ?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/event-types/${eventTypeId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Type d\'Ã©vÃ©nement supprimÃ©' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur suppression type d\'Ã©vÃ©nement:', error);
        this.showMessage('Erreur lors de la suppression', 'error');
      }
    },

    startEditEventType(eventType) {
      this.editingEventTypeId = eventType.id;
      this.editingEventType = {
        id: eventType.id,
        name_fr: eventType.name_fr,
        name_jp: eventType.name_jp,
        description_fr: eventType.description_fr || '',
        description_jp: eventType.description_jp || ''
      };
    },

    cancelEditEventType() {
      this.editingEventTypeId = null;
      this.editingEventType = {};
    },

    async updateEventType() {
      try {
        const response = await fetch(`/api/event-types/${this.editingEventType.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name_fr: this.editingEventType.name_fr,
            name_jp: this.editingEventType.name_jp,
            description_fr: this.editingEventType.description_fr,
            description_jp: this.editingEventType.description_jp
          })
        });

        const data = await response.json();

        if (data.status === 'ok') {
          this.showMessage(
            this.lang === 'fr' ? 'Type d\'Ã©vÃ©nement modifiÃ© avec succÃ¨s' : 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ',
            'success'
          );
          this.editingEventTypeId = null;
          this.editingEventType = {};
          await this.loadData();
        } else {
          this.showMessage(data.message || 'Erreur', 'error');
        }
      } catch (error) {
        console.error('Erreur modification type d\'Ã©vÃ©nement:', error);
        this.showMessage('Erreur lors de la modification du type d\'Ã©vÃ©nement', 'error');
      }
    }
  };
}
</script>
{% endblock %}
