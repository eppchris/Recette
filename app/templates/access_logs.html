<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Logs d\'accès' if lang == 'fr' else 'アクセスログ' }} - Recette</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png?v=2">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png?v=2">
    <link rel="apple-touch-icon" sizes="64x64" href="/static/favicon-64x64.png?v=2">
    <script src="/static/css/tailwind.min.js"></script>
    <script defer src="/static/css/alpine.min.js"></script>
</head>
<body class="bg-gray-50" x-data="{
    darkMode: localStorage.getItem('darkMode') === 'true' || false,
    timeRange: '{{ time_range }}',
    toggleDarkMode() {
        this.darkMode = !this.darkMode;
        localStorage.setItem('darkMode', this.darkMode);
    }
}">
    <div :class="darkMode ? 'dark bg-gray-900' : 'bg-gray-50'" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <a href="/recipes?lang={{ lang }}" class="text-blue-600 dark:text-blue-400 hover:underline">
                            ← {{ 'Retour' if lang == 'fr' else '戻る' }}
                        </a>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                            {{ 'Logs d\'accès' if lang == 'fr' else 'アクセスログ' }}
                        </h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Sélecteur de période -->
                        <form method="GET" action="/access-logs" class="flex items-center gap-2">
                            <input type="hidden" name="lang" value="{{ lang }}">
                            <label class="text-sm text-gray-700 dark:text-gray-300">
                                {{ 'Période:' if lang == 'fr' else '期間:' }}
                            </label>
                            <select name="time_range" x-model="timeRange" onchange="this.form.submit()"
                                    class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700 dark:text-white text-sm">
                                <option value="1">{{ '1 heure' if lang == 'fr' else '1時間' }}</option>
                                <option value="6">{{ '6 heures' if lang == 'fr' else '6時間' }}</option>
                                <option value="24">{{ '24 heures' if lang == 'fr' else '24時間' }}</option>
                                <option value="168">{{ '7 jours' if lang == 'fr' else '7日間' }}</option>
                                <option value="720">{{ '30 jours' if lang == 'fr' else '30日間' }}</option>
                            </select>
                        </form>

                        <!-- Toggle langue -->
                        <a href="?lang={{ 'jp' if lang == 'fr' else 'fr' }}&time_range={{ time_range }}"
                           class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
                            {{ 'JP' if lang == 'fr' else 'FR' }}
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Statistiques globales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                        {{ 'Total des accès' if lang == 'fr' else '総アクセス数' }}
                    </h3>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                        {{ stats.total_accesses }}
                    </p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                        {{ 'IPs uniques' if lang == 'fr' else 'ユニークIP数' }}
                    </h3>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                        {{ stats.by_ip|length }}
                    </p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                        {{ 'Pages visitées' if lang == 'fr' else '訪問ページ数' }}
                    </h3>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                        {{ stats.popular_pages|length }}
                    </p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                        {{ 'Temps moyen' if lang == 'fr' else '平均時間' }}
                    </h3>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                        {% if avg_response_time %}
                            {{ "%.0f"|format(avg_response_time) }}ms
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Accès par IP -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Accès par adresse IP' if lang == 'fr' else 'IPアドレス別アクセス' }}
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Adresse IP' if lang == 'fr' else 'IPアドレス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Nombre d\'accès' if lang == 'fr' else 'アクセス数' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Premier accès' if lang == 'fr' else '最初のアクセス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Dernier accès' if lang == 'fr' else '最後のアクセス' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for ip_stat in stats.by_ip %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ ip_stat.ip_address }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ ip_stat.count }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ ip_stat.first_access }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ ip_stat.last_access }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pages les plus visitées -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Pages les plus visitées' if lang == 'fr' else '最も訪問されたページ' }}
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Chemin' if lang == 'fr' else 'パス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Visites' if lang == 'fr' else '訪問回数' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for page in stats.popular_pages %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ page.path }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ page.count }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pages les plus lentes -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Pages avec temps de réponse le plus élevé' if lang == 'fr' else '応答時間が最も遅いページ' }}
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Chemin' if lang == 'fr' else 'パス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Temps moyen (ms)' if lang == 'fr' else '平均時間 (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Requêtes' if lang == 'fr' else 'リクエスト数' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for slow in stats.slow_pages %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ slow.path }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ "%.1f"|format(slow.avg_time) }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ slow.count }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Comparaison Performance Client vs Serveur -->
            {% if client_stats.server_vs_client %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Performance Client vs Serveur' if lang == 'fr' else 'クライアント vs サーバーパフォーマンス' }}
                    </h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        {{ 'Comparaison du temps serveur avec le temps total perçu par l\'utilisateur (incluant réseau et rendu)' if lang == 'fr' else 'サーバー時間とユーザーが感じる合計時間（ネットワークとレンダリングを含む）の比較' }}
                    </p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Page' if lang == 'fr' else 'ページ' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Serveur (ms)' if lang == 'fr' else 'サーバー (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Total Client (ms)' if lang == 'fr' else 'クライアント合計 (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Réseau (ms)' if lang == 'fr' else 'ネットワーク (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Overhead Client (ms)' if lang == 'fr' else 'クライアント負荷 (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Mesures' if lang == 'fr' else '測定回数' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for perf in client_stats.server_vs_client %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ perf.page_url }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ "%.0f"|format(perf.avg_server_time) }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ "%.0f"|format(perf.avg_total_time) }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {% if perf.avg_network_time %}
                                        {{ "%.0f"|format(perf.avg_network_time) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-sm">
                                    {% set overhead = perf.avg_client_overhead %}
                                    <span class="{% if overhead > 500 %}text-red-600 dark:text-red-400{% elif overhead > 200 %}text-yellow-600 dark:text-yellow-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                                        {{ "%.0f"|format(overhead) }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ perf.count }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Pages les plus lourdes -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Pages les plus lourdes (taille de réponse)' if lang == 'fr' else '最も重いページ（レスポンスサイズ）' }}
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Chemin' if lang == 'fr' else 'パス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Taille moyenne (KB)' if lang == 'fr' else '平均サイズ (KB)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Requêtes' if lang == 'fr' else 'リクエスト数' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for heavy in stats.heavy_pages %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ heavy.path }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ "%.1f"|format(heavy.avg_size / 1024) }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ heavy.count }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Logs récents -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ 'Logs récents (50 derniers)' if lang == 'fr' else '最近のログ（最新50件）' }}
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Date/Heure' if lang == 'fr' else '日時' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    IP
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Méthode' if lang == 'fr' else 'メソッド' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Chemin' if lang == 'fr' else 'パス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Statut' if lang == 'fr' else 'ステータス' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Temps (ms)' if lang == 'fr' else '時間 (ms)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Taille (KB)' if lang == 'fr' else 'サイズ (KB)' }}
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {{ 'Langue' if lang == 'fr' else '言語' }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                            {% for log in recent_logs %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">
                                    {{ log.accessed_at }}
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ log.ip_address }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span class="px-2 py-1 text-xs font-semibold rounded
                                        {% if log.method == 'GET' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                        {% elif log.method == 'POST' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                        {% elif log.method == 'PUT' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                        {% elif log.method == 'DELETE' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                        {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200
                                        {% endif %}">
                                        {{ log.method }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-900 dark:text-white">
                                    {{ log.path }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span class="px-2 py-1 text-xs font-semibold rounded
                                        {% if log.status_code >= 200 and log.status_code < 300 %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                        {% elif log.status_code >= 300 and log.status_code < 400 %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                        {% elif log.status_code >= 400 and log.status_code < 500 %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                        {% elif log.status_code >= 500 %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                        {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200
                                        {% endif %}">
                                        {{ log.status_code }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {% if log.response_time_ms %}
                                        {{ "%.1f"|format(log.response_time_ms) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {% if log.response_size_bytes %}
                                        {{ "%.1f"|format(log.response_size_bytes / 1024) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                    {{ log.lang or '-' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
